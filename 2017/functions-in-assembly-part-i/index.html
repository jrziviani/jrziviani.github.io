<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>Functions in Assembly - Part I | ziviani.net</title>
<meta name=keywords content="C,assembly">
<meta name=description content="What is a function from assembly&rsquo;s point of view and how to write it. Part I.">
<meta name=author content="Jose R. Ziviani">
<link rel=canonical href=https://jrziviani.github.io/2017/functions-in-assembly-part-i/>
<link crossorigin=anonymous href=/assets/css/stylesheet.min.c88963fe2d79462000fd0fb1b3737783c32855d340583e4523343f8735c787f0.css integrity="sha256-yIlj/i15RiAA/Q+xs3N3g8MoVdNAWD5FIzQ/hzXHh/A=" rel="preload stylesheet" as=style>
<link rel=icon href=https://jrziviani.github.io/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://jrziviani.github.io/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://jrziviani.github.io/favicon-32x32.png>
<link rel=apple-touch-icon href=https://jrziviani.github.io/apple-touch-icon.png>
<link rel=mask-icon href=https://jrziviani.github.io/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.92.0">
<link rel=alternate hreflang=en href=https://jrziviani.github.io/2017/functions-in-assembly-part-i/>
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript><meta property="og:title" content="Functions in Assembly - Part I">
<meta property="og:description" content="What is a function from assembly&rsquo;s point of view and how to write it. Part I.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://jrziviani.github.io/2017/functions-in-assembly-part-i/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2017-10-25T09:04:06-08:00">
<meta property="article:modified_time" content="2017-10-25T09:04:06-08:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Functions in Assembly - Part I">
<meta name=twitter:description content="What is a function from assembly&rsquo;s point of view and how to write it. Part I.">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://jrziviani.github.io/posts/"},{"@type":"ListItem","position":3,"name":"Functions in Assembly - Part I","item":"https://jrziviani.github.io/2017/functions-in-assembly-part-i/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Functions in Assembly - Part I","name":"Functions in Assembly - Part I","description":"What is a function from assembly\u0026rsquo;s point of view and how to write it. Part I.","keywords":["C","assembly"],"articleBody":"UPDATE: Part II is ready.\nIn my current job I often need to write instructions in assembly. It’s usually an one-line instruction so I simply embed it in C using inline asm. But when I need to write more than an one-line code I would prefer to write them directly in assembly.\nIs that difficult? Function is a sequence of instructions grouped in a logical sense to perform a particular task, they are abstractions implemented by the programming language. The code generated by compilers make use of labels and jumps, stack and registers. So, you basically need to do the job that your compiler does to you. It’s not difficult but requires some extra work, for instance:\ncat function.S  .align 2 .type my_function,@function;  .globl my_function;  my_function: blr  .align 2 - section is 2-byte aligned. .type my_function,@function - useful for debugging, not required. .globl my_funcion - “my_function” is available outside from this unit. my_function: - label. blr - PowerPC instruction that branches unconditionally to the address stored in Link Register.  $ cat function.c  #include  /* * I'm telling to C compiler that my_function expects and returns an integer. * I'm also making a promise: the implementation will be available later. */ extern int my_function(int param); int main(void) { int i = my_function(5); printf(\"%d\\n\", i); return 0; } $ gcc -g3 function.S function.c -o function $ ./function 5  Isn’t it cool? I just wrote a “function” in assembly that does nothing more than returning the same value used as parameter. Magic? No, and we will see why.\nApplication Binary Interface - ABI To write a compliant C function we need to respect some rules (the same rules that the C compiler respects when it generates the binary code). These rules are defined by the ABI, or Application Binary Interface, that is tied to the target architecture.\nAbout function, it defines rules like: where parameters are a expected to be, how to set up your stack frame, where to store the return values, etc. Those rules help to organize the system in a way that multiple languages can interact with each other (calling libraries, for instance) without problems.\nThe following interactive animation illustrates an imaginary toy processor and how functions work within its simple specification: 3 registers and some memory. This is the code that would be generated by a C compiler for that imaginary target.\nint x = mult(5, 3); printf(\"%d\", x); int y = mult(x, 2); printf(\"%d\", y);  Note: click ‘n’ to go to the next instruction, this is a simple (but real) virtual machine.\n    var vm = undefined; window.addEventListener('keydown', (event) = { if (typeof vm != 'undefined' \u0026\u0026 event.key == 'n' || event.key == 'N') { vm.run_step(); window.requestAnimationFrame( function() { vm.draw(); } ); } }, false); function main() { var canvas = document.getElementById('canvas'); vm = new vm_gui(canvas); window.requestAnimationFrame( function() { vm.draw(); } ); } window.onload = function(event) { main(); } var dx = null; document.addEventListener('touchstart', (event) = { if (event.target.id != \"canvas\") { return; } dx = event.touches[0].clientX; }, false); document.addEventListener('touchmove', (event) = { if (dx === null) { return; } if (event.touches[0].clientX - dx  0) { vm.run_step(); } dx = null; window.requestAnimationFrame( function() { vm.draw(); } ); }, false);  ","wordCount":"531","inLanguage":"en","datePublished":"2017-10-25T09:04:06-08:00","dateModified":"2017-10-25T09:04:06-08:00","author":{"@type":"Person","name":"Jose R. Ziviani"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://jrziviani.github.io/2017/functions-in-assembly-part-i/"},"publisher":{"@type":"Organization","name":"ziviani.net","logo":{"@type":"ImageObject","url":"https://jrziviani.github.io/favicon.ico"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://jrziviani.github.io accesskey=h title="ziviani.net (Alt + H)">ziviani.net</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
<ul class=lang-switch><li>|</li>
<li>
<a href=https://jrziviani.github.io/pt/ title=Portuguese aria-label=:pt:>Pt</a>
</li>
</ul>
</span>
</div>
<ul id=menu>
<li>
<a href=https://jrziviani.github.io/archives title=Archive>
<span>Archive</span>
</a>
</li>
<li>
<a href=https://jrziviani.github.io/search title="Search (Alt + /)" accesskey=/>
<span>Search</span>
</a>
</li>
<li>
<a href=https://jrziviani.github.io/tags title=Tags>
<span>Tags</span>
</a>
</li>
<li>
<a href=https://jrziviani.github.io/about title=About>
<span>About</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<div class=breadcrumbs><a href=https://jrziviani.github.io>Home</a>&nbsp;»&nbsp;<a href=https://jrziviani.github.io/posts/>Posts</a></div>
<h1 class=post-title>
Functions in Assembly - Part I
</h1>
<div class=post-meta><span title="2017-10-25 09:04:06 -0800 -0800">October 25, 2017</span>&nbsp;·&nbsp;3 min&nbsp;·&nbsp;Jose R. Ziviani
</div>
</header> <div class=toc>
<details>
<summary accesskey=c title="(Alt + C)">
<span class=details>Table of Contents</span>
</summary>
<div class=inner><ul>
<li>
<a href=#is-that-difficult aria-label="Is that difficult?">Is that difficult?</a></li>
<li>
<a href=#application-binary-interface---abi aria-label="Application Binary Interface - ABI">Application Binary Interface - ABI</a>
</li>
</ul>
</div>
</details>
</div>
<div class=post-content><p><strong>UPDATE</strong>: <a href=/2017/functions-in-assembly-ii>Part II</a> is ready.</p>
<p>In my current job I often need to write instructions in assembly. It&rsquo;s usually an one-line instruction so I simply embed it in C using inline asm. But when I need to write more than an one-line code I would prefer to write them directly in assembly.</p>
<h3 id=is-that-difficult>Is that difficult?<a hidden class=anchor aria-hidden=true href=#is-that-difficult>#</a></h3>
<p>Function is a sequence of instructions grouped in a logical sense to perform a particular task, they are abstractions implemented by the programming language. The code generated by compilers make use of labels and jumps, stack and registers. So, you basically need to do the job that your compiler does to you. It&rsquo;s not difficult but requires some extra work, for instance:</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console>    cat function.S
</code></pre></div>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm>    .align <span style=color:#2aa198>2</span>
    .type <span style=color:#cb4b16>my_function</span>,@function<span style=color:#586e75>;
</span><span style=color:#586e75></span>    <span style=color:#cb4b16>.globl</span> <span style=color:#cb4b16>my_function</span><span style=color:#586e75>;
</span><span style=color:#586e75></span>    <span style=color:#cb4b16>my_function</span>:
        <span style=color:#268bd2>blr</span></code></pre></div>
<ul>
<li><strong>.align 2</strong> - section is 2-byte aligned.</li>
<li><strong>.type my_function,@function</strong> - useful for debugging, not required.</li>
<li><strong>.globl my_funcion</strong> - &ldquo;my_function&rdquo; is available outside from this unit.</li>
<li><strong>my_function:</strong> - label.</li>
<li><strong>blr</strong> - PowerPC instruction that branches unconditionally to the address stored in Link Register.</li>
</ul>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console>    $ cat function.c
</code></pre></div>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>    <span style=color:#719e07>#include</span> <span style=color:#719e07>&lt;stdio.h&gt;</span><span style=color:#719e07>
</span><span style=color:#719e07></span>    
    <span style=color:#586e75>/*
</span><span style=color:#586e75>     * I&#39;m telling to C compiler that my_function expects and returns an integer.
</span><span style=color:#586e75>     * I&#39;m also making a promise: the implementation will be available later.
</span><span style=color:#586e75>     */</span>
    <span style=color:#719e07>extern</span> <span style=color:#dc322f>int</span> <span style=color:#268bd2>my_function</span>(<span style=color:#dc322f>int</span> param);
    
    <span style=color:#dc322f>int</span> <span style=color:#268bd2>main</span>(<span style=color:#dc322f>void</span>)
    {
        <span style=color:#dc322f>int</span> i <span style=color:#719e07>=</span> my_function(<span style=color:#2aa198>5</span>);
        printf(<span style=color:#2aa198>&#34;%d</span><span style=color:#cb4b16>\n</span><span style=color:#2aa198>&#34;</span>, i);
        <span style=color:#719e07>return</span> <span style=color:#2aa198>0</span>;
    }</code></pre></div>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console>    $ gcc -g3 function.S function.c -o function
    $ ./function
    5
</code></pre></div>
<p>Isn&rsquo;t it cool? I just wrote a &ldquo;function&rdquo; in assembly that does nothing more than returning the same value used as parameter. Magic? No, and we will see why.</p>
<h3 id=application-binary-interface---abi>Application Binary Interface - ABI<a hidden class=anchor aria-hidden=true href=#application-binary-interface---abi>#</a></h3>
<p>To write a compliant C function we need to respect some rules <em>(the same rules that the C compiler respects when it generates the binary code)</em>. These rules are defined by the ABI, or <a href=https://en.wikipedia.org/wiki/Application_binary_interface>Application Binary Interface</a>, that is tied to the target architecture.</p>
<p>About function, it defines rules like: where parameters are a expected to be, how to set up your stack frame, where to store the return values, etc. Those rules help to organize the system in a way that multiple languages can interact with each other (calling libraries, for instance) without problems.</p>
<p>The following interactive animation illustrates an imaginary toy processor and how functions work within its simple specification: 3 registers and some memory. This is the code that would be generated by a C compiler for that imaginary target.</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>    <span style=color:#dc322f>int</span> x <span style=color:#719e07>=</span> mult(<span style=color:#2aa198>5</span>, <span style=color:#2aa198>3</span>);
    printf(<span style=color:#2aa198>&#34;%d&#34;</span>, x);
    <span style=color:#dc322f>int</span> y <span style=color:#719e07>=</span> mult(x, <span style=color:#2aa198>2</span>);
    printf(<span style=color:#2aa198>&#34;%d&#34;</span>, y);</code></pre></div>
<blockquote>
<p><strong>Note:</strong> click <strong>&lsquo;n&rsquo;</strong> to go to the next instruction, this is a simple (but real) <a href=/vm.js>virtual machine</a>.</p>
</blockquote>
<canvas id=canvas width=1024px height=800px></canvas>
<script type=text/javascript src=/js/vm.js></script>
<script type=text/javascript src=/js/vm_iface.js></script>
<script type=text/javascript charset=utf-8>var vm=void 0,dx;window.addEventListener('keydown',a=>{(typeof vm!='undefined'&&a.key=='n'||a.key=='N')&&(vm.run_step(),window.requestAnimationFrame(function(){vm.draw()}))},!1);function main(){var a=document.getElementById('canvas');vm=new vm_gui(a),window.requestAnimationFrame(function(){vm.draw()})}window.onload=function(a){main()},dx=null,document.addEventListener('touchstart',a=>{if(a.target.id!="canvas")return;dx=a.touches[0].clientX},!1),document.addEventListener('touchmove',a=>{if(dx===null)return;a.touches[0].clientX-dx>0&&vm.run_step(),dx=null,window.requestAnimationFrame(function(){vm.draw()})},!1)</script>
</div>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=https://jrziviani.github.io/tags/c/>C</a></li>
<li><a href=https://jrziviani.github.io/tags/assembly/>assembly</a></li>
</ul>
<nav class=paginav>
<a class=prev href=https://jrziviani.github.io/2017/fpga-cyclone-iv-altera/>
<span class=title>« Prev Page</span>
<br>
<span>FPGA Cyclone IV - Altera</span>
</a>
<a class=next href=https://jrziviani.github.io/2017/using-the-kvm-api-powerpc-64-version/>
<span class=title>Next Page »</span>
<br>
<span>Using the KVM API - PowerPC 64 version</span>
</a>
</nav>
</footer>
</article>
</main>
<footer class=footer>
<span>&copy; 2022 <a href=https://jrziviani.github.io>ziviani.net</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
</body>
</html>
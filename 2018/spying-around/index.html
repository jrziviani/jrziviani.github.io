<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>Spying Around | ziviani.net</title>
<meta name=keywords content="C++,hacking,linux">
<meta name=description content="Inspecting other process memory for fun&mldr;">
<meta name=author content="Jose R. Ziviani">
<link rel=canonical href=https://jrziviani.github.io/2018/spying-around/>
<link crossorigin=anonymous href=/assets/css/stylesheet.min.c88963fe2d79462000fd0fb1b3737783c32855d340583e4523343f8735c787f0.css integrity="sha256-yIlj/i15RiAA/Q+xs3N3g8MoVdNAWD5FIzQ/hzXHh/A=" rel="preload stylesheet" as=style>
<link rel=icon href=https://jrziviani.github.io/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://jrziviani.github.io/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://jrziviani.github.io/favicon-32x32.png>
<link rel=apple-touch-icon href=https://jrziviani.github.io/apple-touch-icon.png>
<link rel=mask-icon href=https://jrziviani.github.io/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.92.0">
<link rel=alternate hreflang=en href=https://jrziviani.github.io/2018/spying-around/>
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript><meta property="og:title" content="Spying Around">
<meta property="og:description" content="Inspecting other process memory for fun&mldr;">
<meta property="og:type" content="article">
<meta property="og:url" content="https://jrziviani.github.io/2018/spying-around/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2018-08-12T17:19:27-08:00">
<meta property="article:modified_time" content="2018-08-12T17:19:27-08:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Spying Around">
<meta name=twitter:description content="Inspecting other process memory for fun&mldr;">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://jrziviani.github.io/posts/"},{"@type":"ListItem","position":3,"name":"Spying Around","item":"https://jrziviani.github.io/2018/spying-around/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Spying Around","name":"Spying Around","description":"Inspecting other process memory for fun\u0026hellip;","keywords":["C++","hacking","linux"],"articleBody":"This small project examines the memory of another process and it prints a map with all mines exposed. The source code is at Github Gist.\nWhen you click on a cell the game checks whether you’re safe or not. So, the mouse click triggers an event that calls a function to make that check. Using the command strings we can find the function names available.\n% strings /usr/bin/gnome-mines ... minefield_clear_mine minefield_multi_release minefield_is_location minefield_is_cleared minefield_has_mine  The amount of printed strings is scary. Yet, after a quick look, we find very promising names such as minefiled_has_mine. If that’s a function it needs to know where the mines are and our job is to know how to locate them and read them.\n% gnome-mines\u0026 [1] 28978  % gdb -p 28978 (gdb) disassemble minefield_has_mine Dump of assembler code for function minefield_has_mine: 0x000056551241db30 0:\tendbr64 0x000056551241db34 4:\ttest %rdi,%rdi 0x000056551241db37 7:\tje 0x56551241db50 minefield_has_mine+32 0x000056551241db39 9:\timul 0x3c(%rdi),%esi 0x000056551241db3d 13:\tmov 0x30(%rdi),%rax 0x000056551241db41 17:\tadd %esi,%edx 0x000056551241db43 19:\tmov (%rax,%rdx,8),%rax 0x000056551241db47 23:\tmov 0x20(%rax),%eax 0x000056551241db4a 26:\tretq 0x000056551241db4b 27:\tnopl 0x0(%rax,%rax,1) 0x000056551241db50 32:\tsub $0x8,%rsp 0x000056551241db54 36:\tlea 0x6829(%rip),%rdx # 0x565512424384  0x000056551241db5b 43:\tlea 0x7cde(%rip),%rsi # 0x565512425840  0x000056551241db62 50:\txor %edi,%edi 0x000056551241db64 52:\tcallq 0x565512417390 g_return_if_fail_warning@plt 0x000056551241db69 57:\txor %eax,%eax 0x000056551241db6b 59:\tadd $0x8,%rsp 0x000056551241db6f 63:\tretq End of assembler dump. (gdb) b *0x000056551241db39 Breakpoint 1 at 0x56551241db39 (gdb) c Continuing Great minefield_has_mine is a function indeed! By clicking on a cell the game should call that function and GDB will luckily stop at the required point.\nThread 1 \"gnome-mines\" hit Breakpoint 1, 0x000056551241db39 in minefield_has_mine () (gdb) display/i $pc 1: x/i $pc = 0x56551241db39 minefield_has_mine+9:\timul 0x3c(%rdi),%esi (gdb) x /gx $rdi + 0x3c 0x56551330cccc:\t0x0000000000000008 (gdb) print /x $esi $1 = 0x0 Hmmm, it’s multiplying $rdi+0x3c = 8 with $esi = 0. At first sight, it seems that $rdi+0x3c is the number of lines in the board and $esi is the selected column cell. After the multiplication $esi will store the skipped cells to reach to the required cell.\nLet’s take a deeper look at $rdi, it seems to have more information for us.\n(gdb) x /30gx $rdi 0x56551330cc90:\t0x000056551316a5a0\t0x0000000000000004 0x56551330cca0:\t0x00005655133c7be0\t0x000056551330cc70 0x56551330ccb0:\t0x0000000800000008\t0x000000000000000a 0x56551330ccc0:\t0x00005655131327c0\t0x0000000800000008 0x56551330ccd0:\t0x0000000100000000\t0x0000000000000000 0x56551330cce0:\t0x00007f19aac74450\t0x0000001c00000004 0x56551330ccf0:\t0x0000000000000000\t0x0000000000000000 0x56551330cd00:\t0x000056551332ee40\t0x0000565512fa49e0 0x56551330cd10:\t0x0000000000000000\t0xffffffffffffffff 0x56551330cd20:\t0x00000000ffffffff\t0x0000000000000000 0x56551330cd30:\t0x0000565512e76170\t0x0000000000000001 0x56551330cd40:\t0x0000000000000000\t0x000056551330cce0 0x56551330cd50:\t0x0000565512d46020\t0x0000000000001202 0x56551330cd60:\t0x0000565512d90a40\t0x000056551330cb30 0x56551330cd70:\t0x000056551332ecc0\t0x0000000000000000 Well, the register seems to have the address of the main game object. At 0x56551330ccb0 we can find the board size (8x8) and the total number of mines (0xa = 10).\n(gdb) ni 0x000056551241db3d in minefield_has_mine () 1: x/i $pc = 0x56551241db3d minefield_has_mine+13:\tmov 0x30(%rdi),%rax (gdb) x /gx $rdi+0x30 0x56551330ccc0:\t0x00005655131327c0 COMMENT: $rdi+0x30 is an address (possibly pointing to another object). (gdb) ni 0x000056551241db41 in minefield_has_mine () 1: x/i $pc = 0x56551241db41 minefield_has_mine+17:\tadd %esi,%edx (gdb) print /x $edx $2 = 0x0 (gdb) print /x $esi $3 = 0x0 COMMENT: $edx has the selected cell line number, it sums to the $esi found above to have the offset to required cell. (gdb) ni 0x000056551241db43 in minefield_has_mine () 1: x/i $pc = 0x56551241db43 minefield_has_mine+19:\tmov (%rax,%rdx,8),%rax COMMENT: copy the content of [$rdx * 8 + $rax] to $rax. That 8 has nothing to do with the map, it´s possible the number of bytes between different objects of that map. (gdb) ni 0x000056551241db47 in minefield_has_mine () 1: x/i $pc = 0x56551241db47 minefield_has_mine+23:\tmov 0x20(%rax),%eax COMMENT: $rax+0x20 is our cell: 0 if empty, otherwise 1. Copying it to $eax and retuning (next instruction) will return this value. (gdb) ni 0x000056551241db4a in minefield_has_mine () 1: x/i $pc = 0x56551241db4a minefield_has_mine+26:\tretq Now the job is to translate that assembly code to C language, which is quite straightforward. My code uses the initial heap address and loops the whole range looking for the [row, column, mine]. Then, we need to use the same offsets to access the map.\nbase frame = {stoi(argv[2]), stoi(argv[3]), stoi(argv[4])}; auto address = search_memory(fd, addresses, frame); if (address == 0) { cerr  \"cannot find the board in memory.\\n\"; return 4; } pread(fd, \u0026location, sizeof(uint64_t), static_castoff_t(address + 0x30)); pread(fd, \u0026mine_pos, sizeof(int32_t), static_castoff_t(address + 0x3c)); for (int i = 0; i  frame.height; ++i) { for (int j = 0; j  frame.width; ++j) { auto index = 8 * (mine_pos * j + i); pread(fd, \u0026has_mine_p, sizeof(uint64_t), static_castoff_t((location + index))); pread(fd, \u0026has_mine, sizeof(int32_t), static_castoff_t(has_mine_p + 0x20)); cout  has_mine  \" \"; } cout  endl; } How to use it % g++ -std=c++17 -g3 mines.cpp -o mines % gnome-mines\u0026 [1] 13264 % ./mines 13264 16 16 40 0 0 0 0 0 0 1 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 1 0 1 1 0 0 0 0 0 0 1 0 1 0 0 1 0 1 1 0 0 0 0 0 0 1 0 1 0 0 0 1 0 0 1 0 0 1 0 1 0 0 0 1 0 1 0 0 0 1 0 0 1 1 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 1 0 1 1 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 1 0 0 0 0 1 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 1 0 0 0 0 0 0 0 0 0 0 0 1 1 0 0 0 0 0  ","wordCount":"1029","inLanguage":"en","datePublished":"2018-08-12T17:19:27-08:00","dateModified":"2018-08-12T17:19:27-08:00","author":{"@type":"Person","name":"Jose R. Ziviani"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://jrziviani.github.io/2018/spying-around/"},"publisher":{"@type":"Organization","name":"ziviani.net","logo":{"@type":"ImageObject","url":"https://jrziviani.github.io/favicon.ico"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://jrziviani.github.io accesskey=h title="ziviani.net (Alt + H)">ziviani.net</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
<ul class=lang-switch><li>|</li>
<li>
<a href=https://jrziviani.github.io/pt/ title=Portuguese aria-label=:pt:>Pt</a>
</li>
</ul>
</span>
</div>
<ul id=menu>
<li>
<a href=https://jrziviani.github.io/archives title=Archive>
<span>Archive</span>
</a>
</li>
<li>
<a href=https://jrziviani.github.io/search title="Search (Alt + /)" accesskey=/>
<span>Search</span>
</a>
</li>
<li>
<a href=https://jrziviani.github.io/tags title=Tags>
<span>Tags</span>
</a>
</li>
<li>
<a href=https://jrziviani.github.io/about title=About>
<span>About</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<div class=breadcrumbs><a href=https://jrziviani.github.io>Home</a>&nbsp;»&nbsp;<a href=https://jrziviani.github.io/posts/>Posts</a></div>
<h1 class=post-title>
Spying Around
</h1>
<div class=post-meta><span title="2018-08-12 17:19:27 -0800 -0800">August 12, 2018</span>&nbsp;·&nbsp;5 min&nbsp;·&nbsp;Jose R. Ziviani
</div>
</header> <div class=toc>
<details>
<summary accesskey=c title="(Alt + C)">
<span class=details>Table of Contents</span>
</summary>
<div class=inner><ul>
<li>
<a href=#how-to-use-it aria-label="How to use it">How to use it</a>
</li>
</ul>
</div>
</details>
</div>
<div class=post-content><p>This small project examines the memory of another process and it prints a map with all mines exposed. The source code is at <a href=https://gist.github.com/jrziviani/b28bd7e15d8ef6fd28f63c44665f32c6>Github Gist</a>.</p>
<p><img loading=lazy src=/mines_example.png alt="mines example">
When you click on a cell the game checks whether you&rsquo;re safe or not. So, the mouse click triggers an event that calls a function to make that check. Using the command <code>strings</code> we can find the function names available.</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console>    % strings /usr/bin/gnome-mines
    ...
    minefield_clear_mine
    minefield_multi_release
    minefield_is_location
    minefield_is_cleared
    minefield_has_mine    &lt;=====
    minefield_is_clock_started
    return_value != NULL
    completedField
    ...
</code></pre></div>
<p>The amount of printed strings is scary. Yet, after a quick look, we find very promising names such as <code>minefiled_has_mine</code>. If that&rsquo;s a function it needs to know where the mines are and our job is to know how to locate them and read them.</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console>    % gnome-mines&amp;
    [1] 28978
</code></pre></div>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm>    % <span style=color:#268bd2>gdb</span> -<span style=color:#cb4b16>p</span> <span style=color:#2aa198>28978</span>
    (<span style=color:#268bd2>gdb</span>) <span style=color:#cb4b16>disassemble</span> <span style=color:#cb4b16>minefield_has_mine</span> 
    <span style=color:#cb4b16>Dump</span> <span style=color:#cb4b16>of</span> <span style=color:#cb4b16>assembler</span> <span style=color:#cb4b16>code</span> <span style=color:#cb4b16>for</span> <span style=color:#cb4b16>function</span> <span style=color:#cb4b16>minefield_has_mine</span>:
       0<span style=color:#268bd2>x000056551241db30</span> &lt;+<span style=color:#2aa198>0</span>&gt;:	<span style=color:#cb4b16>endbr64</span> 
       <span style=color:#2aa198>0x000056551241db34</span> &lt;+<span style=color:#2aa198>4</span>&gt;:	<span style=color:#cb4b16>test</span>   <span style=color:#268bd2>%rdi</span>,<span style=color:#268bd2>%rdi</span>
       0<span style=color:#268bd2>x000056551241db37</span> &lt;+<span style=color:#2aa198>7</span>&gt;:	<span style=color:#cb4b16>je</span>     <span style=color:#2aa198>0x56551241db50</span> &lt;<span style=color:#cb4b16>minefield_has_mine</span>+<span style=color:#2aa198>32</span>&gt;
       0<span style=color:#268bd2>x000056551241db39</span> &lt;+<span style=color:#2aa198>9</span>&gt;:	<span style=color:#cb4b16>imul</span>   <span style=color:#2aa198>0x3c</span>(<span style=color:#268bd2>%rdi</span>),<span style=color:#268bd2>%esi</span>
       0<span style=color:#268bd2>x000056551241db3d</span> &lt;+<span style=color:#2aa198>13</span>&gt;:	<span style=color:#cb4b16>mov</span>    <span style=color:#2aa198>0x30</span>(<span style=color:#268bd2>%rdi</span>),<span style=color:#268bd2>%rax</span>
       0<span style=color:#268bd2>x000056551241db41</span> &lt;+<span style=color:#2aa198>17</span>&gt;:	<span style=color:#cb4b16>add</span>    <span style=color:#268bd2>%esi</span>,<span style=color:#268bd2>%edx</span>
       0<span style=color:#268bd2>x000056551241db43</span> &lt;+<span style=color:#2aa198>19</span>&gt;:	<span style=color:#cb4b16>mov</span>    (<span style=color:#268bd2>%rax</span>,<span style=color:#268bd2>%rdx</span>,<span style=color:#2aa198>8</span>),<span style=color:#268bd2>%rax</span>
       0<span style=color:#268bd2>x000056551241db47</span> &lt;+<span style=color:#2aa198>23</span>&gt;:	<span style=color:#cb4b16>mov</span>    <span style=color:#2aa198>0x20</span>(<span style=color:#268bd2>%rax</span>),<span style=color:#268bd2>%eax</span>
       0<span style=color:#268bd2>x000056551241db4a</span> &lt;+<span style=color:#2aa198>26</span>&gt;:	<span style=color:#cb4b16>retq</span>
       0<span style=color:#268bd2>x000056551241db4b</span> &lt;+<span style=color:#2aa198>27</span>&gt;:	<span style=color:#cb4b16>nopl</span>   <span style=color:#2aa198>0x0</span>(<span style=color:#268bd2>%rax</span>,<span style=color:#268bd2>%rax</span>,<span style=color:#2aa198>1</span>)
       0<span style=color:#268bd2>x000056551241db50</span> &lt;+<span style=color:#2aa198>32</span>&gt;:	<span style=color:#cb4b16>sub</span>    <span style=color:#cb4b16>$0x8</span>,<span style=color:#268bd2>%rsp</span>
       0<span style=color:#268bd2>x000056551241db54</span> &lt;+<span style=color:#2aa198>36</span>&gt;:	<span style=color:#cb4b16>lea</span>    <span style=color:#2aa198>0x6829</span>(<span style=color:#268bd2>%rip</span>),<span style=color:#268bd2>%rdx</span>        <span style=color:#586e75># 0x565512424384
</span><span style=color:#586e75></span>       <span style=color:#2aa198>0x000056551241db5b</span> &lt;+<span style=color:#2aa198>43</span>&gt;:	<span style=color:#cb4b16>lea</span>    <span style=color:#2aa198>0x7cde</span>(<span style=color:#268bd2>%rip</span>),<span style=color:#268bd2>%rsi</span>        <span style=color:#586e75># 0x565512425840
</span><span style=color:#586e75></span>       <span style=color:#2aa198>0x000056551241db62</span> &lt;+<span style=color:#2aa198>50</span>&gt;:	<span style=color:#cb4b16>xor</span>    <span style=color:#268bd2>%edi</span>,<span style=color:#268bd2>%edi</span>
       0<span style=color:#268bd2>x000056551241db64</span> &lt;+<span style=color:#2aa198>52</span>&gt;:	<span style=color:#cb4b16>callq</span>  <span style=color:#2aa198>0x565512417390</span> &lt;<span style=color:#cb4b16>g_return_if_fail_warning@plt</span>&gt;
       0<span style=color:#268bd2>x000056551241db69</span> &lt;+<span style=color:#2aa198>57</span>&gt;:	<span style=color:#cb4b16>xor</span>    <span style=color:#268bd2>%eax</span>,<span style=color:#268bd2>%eax</span>
       0<span style=color:#268bd2>x000056551241db6b</span> &lt;+<span style=color:#2aa198>59</span>&gt;:	<span style=color:#cb4b16>add</span>    <span style=color:#cb4b16>$0x8</span>,<span style=color:#268bd2>%rsp</span>
       0<span style=color:#268bd2>x000056551241db6f</span> &lt;+<span style=color:#2aa198>63</span>&gt;:	<span style=color:#cb4b16>retq</span>
    <span style=color:#268bd2>End</span> <span style=color:#cb4b16>of</span> <span style=color:#cb4b16>assembler</span> <span style=color:#cb4b16>dump.</span>
    
    (<span style=color:#268bd2>gdb</span>) <span style=color:#cb4b16>b</span> *<span style=color:#2aa198>0x000056551241db39</span>
    <span style=color:#268bd2>Breakpoint</span> <span style=color:#2aa198>1</span> <span style=color:#cb4b16>at</span> <span style=color:#2aa198>0x56551241db39</span>
    (<span style=color:#268bd2>gdb</span>) <span style=color:#cb4b16>c</span>
    <span style=color:#268bd2>Continuing</span></code></pre></div>
<p>Great <code>minefield_has_mine</code> is a function indeed! By clicking on a cell the game should call that function and GDB will luckily stop at the required point.</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm>    <span style=color:#268bd2>Thread</span> <span style=color:#2aa198>1</span> &#34;<span style=color:#cb4b16>gnome-mines</span>&#34; <span style=color:#cb4b16>hit</span> <span style=color:#cb4b16>Breakpoint</span> <span style=color:#2aa198>1</span>, <span style=color:#2aa198>0x000056551241db39</span> <span style=color:#cb4b16>in</span> <span style=color:#cb4b16>minefield_has_mine</span> ()
    (<span style=color:#268bd2>gdb</span>) <span style=color:#cb4b16>display</span>/<span style=color:#cb4b16>i</span> <span style=color:#cb4b16>$pc</span>
    1: <span style=color:#268bd2>x</span>/<span style=color:#cb4b16>i</span> <span style=color:#cb4b16>$pc</span>
    =&gt; 0<span style=color:#268bd2>x56551241db39</span> &lt;<span style=color:#cb4b16>minefield_has_mine</span>+<span style=color:#2aa198>9</span>&gt;:	<span style=color:#cb4b16>imul</span>   <span style=color:#2aa198>0x3c</span>(<span style=color:#268bd2>%rdi</span>),<span style=color:#268bd2>%esi</span>
    (<span style=color:#268bd2>gdb</span>) <span style=color:#cb4b16>x</span> /<span style=color:#cb4b16>gx</span> <span style=color:#cb4b16>$rdi</span> + <span style=color:#2aa198>0x3c</span>
    0x56551330cccc:	0<span style=color:#268bd2>x0000000000000008</span>
    (<span style=color:#268bd2>gdb</span>) <span style=color:#cb4b16>print</span> /<span style=color:#cb4b16>x</span> <span style=color:#cb4b16>$esi</span>
    <span style=color:#268bd2>$1</span> = <span style=color:#2aa198>0x0</span></code></pre></div>
<p>Hmmm, it&rsquo;s multiplying <code>$rdi+0x3c = 8</code> with <code>$esi = 0</code>. At first sight, it seems that <code>$rdi+0x3c</code> is the number of lines in the board and <code>$esi</code> is the selected column cell. After the multiplication <code>$esi</code> will store the skipped cells to reach to the required cell.</p>
<p>Let&rsquo;s take a deeper look at <code>$rdi</code>, it seems to have more information for us.</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm>    (<span style=color:#268bd2>gdb</span>) <span style=color:#cb4b16>x</span> /<span style=color:#2aa198>30</span><span style=color:#cb4b16>gx</span> <span style=color:#cb4b16>$rdi</span>
    0x56551330cc90:	0<span style=color:#268bd2>x000056551316a5a0</span>	<span style=color:#2aa198>0x0000000000000004</span>
    0x56551330cca0:	0<span style=color:#268bd2>x00005655133c7be0</span>	<span style=color:#2aa198>0x000056551330cc70</span>
    0x56551330ccb0:	0<span style=color:#268bd2>x0000000800000008</span>	<span style=color:#2aa198>0x000000000000000a</span>
    0x56551330ccc0:	0<span style=color:#268bd2>x00005655131327c0</span>	<span style=color:#2aa198>0x0000000800000008</span>
    0x56551330ccd0:	0<span style=color:#268bd2>x0000000100000000</span>	<span style=color:#2aa198>0x0000000000000000</span>
    0x56551330cce0:	0<span style=color:#268bd2>x00007f19aac74450</span>	<span style=color:#2aa198>0x0000001c00000004</span>
    0x56551330ccf0:	0<span style=color:#268bd2>x0000000000000000</span>	<span style=color:#2aa198>0x0000000000000000</span>
    0x56551330cd00:	0<span style=color:#268bd2>x000056551332ee40</span>	<span style=color:#2aa198>0x0000565512fa49e0</span>
    0x56551330cd10:	0<span style=color:#268bd2>x0000000000000000</span>	<span style=color:#2aa198>0xffffffffffffffff</span>
    0x56551330cd20:	0<span style=color:#268bd2>x00000000ffffffff</span>	<span style=color:#2aa198>0x0000000000000000</span>
    0x56551330cd30:	0<span style=color:#268bd2>x0000565512e76170</span>	<span style=color:#2aa198>0x0000000000000001</span>
    0x56551330cd40:	0<span style=color:#268bd2>x0000000000000000</span>	<span style=color:#2aa198>0x000056551330cce0</span>
    0x56551330cd50:	0<span style=color:#268bd2>x0000565512d46020</span>	<span style=color:#2aa198>0x0000000000001202</span>
    0x56551330cd60:	0<span style=color:#268bd2>x0000565512d90a40</span>	<span style=color:#2aa198>0x000056551330cb30</span>
    0x56551330cd70:	0<span style=color:#268bd2>x000056551332ecc0</span>	<span style=color:#2aa198>0x0000000000000000</span></code></pre></div>
<p>Well, the register seems to have the address of the main game object. At <code>0x56551330ccb0</code> we can find the board size (8x8) and the total number of mines (0xa => 10).</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm>    (<span style=color:#268bd2>gdb</span>) <span style=color:#cb4b16>ni</span>
    0<span style=color:#268bd2>x000056551241db3d</span> <span style=color:#cb4b16>in</span> <span style=color:#cb4b16>minefield_has_mine</span> ()
    1: <span style=color:#268bd2>x</span>/<span style=color:#cb4b16>i</span> <span style=color:#cb4b16>$pc</span>
    =&gt; 0<span style=color:#268bd2>x56551241db3d</span> &lt;<span style=color:#cb4b16>minefield_has_mine</span>+<span style=color:#2aa198>13</span>&gt;:	<span style=color:#cb4b16>mov</span>    <span style=color:#2aa198>0x30</span>(<span style=color:#268bd2>%rdi</span>),<span style=color:#268bd2>%rax</span>
    (<span style=color:#268bd2>gdb</span>) <span style=color:#cb4b16>x</span> /<span style=color:#cb4b16>gx</span> <span style=color:#cb4b16>$rdi</span>+<span style=color:#2aa198>0x30</span>
    0x56551330ccc0:	0<span style=color:#268bd2>x00005655131327c0</span>
    COMMENT: <span style=color:#268bd2>$rdi</span>+<span style=color:#2aa198>0x30</span> <span style=color:#cb4b16>is</span> <span style=color:#cb4b16>an</span> <span style=color:#cb4b16>address</span> (<span style=color:#cb4b16>possibly</span> <span style=color:#cb4b16>pointing</span> <span style=color:#cb4b16>to</span> <span style=color:#cb4b16>another</span> <span style=color:#cb4b16>object</span>).
    
    (<span style=color:#268bd2>gdb</span>) <span style=color:#cb4b16>ni</span>
    0<span style=color:#268bd2>x000056551241db41</span> <span style=color:#cb4b16>in</span> <span style=color:#cb4b16>minefield_has_mine</span> ()
    1: <span style=color:#268bd2>x</span>/<span style=color:#cb4b16>i</span> <span style=color:#cb4b16>$pc</span>
    =&gt; 0<span style=color:#268bd2>x56551241db41</span> &lt;<span style=color:#cb4b16>minefield_has_mine</span>+<span style=color:#2aa198>17</span>&gt;:	<span style=color:#cb4b16>add</span>    <span style=color:#268bd2>%esi</span>,<span style=color:#268bd2>%edx</span>
    (<span style=color:#268bd2>gdb</span>) <span style=color:#cb4b16>print</span> /<span style=color:#cb4b16>x</span> <span style=color:#cb4b16>$edx</span>
    <span style=color:#268bd2>$2</span> = <span style=color:#2aa198>0x0</span>
    (<span style=color:#268bd2>gdb</span>) <span style=color:#cb4b16>print</span> /<span style=color:#cb4b16>x</span> <span style=color:#cb4b16>$esi</span>
    <span style=color:#268bd2>$3</span> = <span style=color:#2aa198>0x0</span>
    COMMENT: <span style=color:#268bd2>$edx</span> <span style=color:#cb4b16>has</span> <span style=color:#cb4b16>the</span> <span style=color:#cb4b16>selected</span> <span style=color:#cb4b16>cell</span> <span style=color:#cb4b16>line</span> <span style=color:#cb4b16>number</span>, <span style=color:#cb4b16>it</span> <span style=color:#cb4b16>sums</span> <span style=color:#cb4b16>to</span> <span style=color:#cb4b16>the</span> <span style=color:#cb4b16>$esi</span> <span style=color:#cb4b16>found</span> <span style=color:#cb4b16>above</span> <span style=color:#cb4b16>to</span> <span style=color:#cb4b16>have</span> <span style=color:#cb4b16>the</span> <span style=color:#cb4b16>offset</span> <span style=color:#cb4b16>to</span> <span style=color:#cb4b16>required</span> <span style=color:#cb4b16>cell.</span>
    
    (<span style=color:#268bd2>gdb</span>) <span style=color:#cb4b16>ni</span>
    0<span style=color:#268bd2>x000056551241db43</span> <span style=color:#cb4b16>in</span> <span style=color:#cb4b16>minefield_has_mine</span> ()
    1: <span style=color:#268bd2>x</span>/<span style=color:#cb4b16>i</span> <span style=color:#cb4b16>$pc</span>
    =&gt; 0<span style=color:#268bd2>x56551241db43</span> &lt;<span style=color:#cb4b16>minefield_has_mine</span>+<span style=color:#2aa198>19</span>&gt;:	<span style=color:#cb4b16>mov</span>    (<span style=color:#268bd2>%rax</span>,<span style=color:#268bd2>%rdx</span>,<span style=color:#2aa198>8</span>),<span style=color:#268bd2>%rax</span>
    COMMENT: <span style=color:#268bd2>copy</span> <span style=color:#cb4b16>the</span> <span style=color:#cb4b16>content</span> <span style=color:#cb4b16>of</span> [<span style=color:#cb4b16>$rdx</span> * <span style=color:#2aa198>8</span> + <span style=color:#cb4b16>$rax</span>] <span style=color:#cb4b16>to</span> <span style=color:#cb4b16>$rax.</span> <span style=color:#cb4b16>That</span> <span style=color:#2aa198>8</span> <span style=color:#cb4b16>has</span> <span style=color:#cb4b16>nothing</span> <span style=color:#cb4b16>to</span> <span style=color:#cb4b16>do</span> <span style=color:#cb4b16>with</span> <span style=color:#cb4b16>the</span> <span style=color:#cb4b16>map</span>, <span style=color:#cb4b16>it</span>´<span style=color:#cb4b16>s</span> <span style=color:#cb4b16>possible</span> <span style=color:#cb4b16>the</span> <span style=color:#cb4b16>number</span> <span style=color:#cb4b16>of</span> <span style=color:#cb4b16>bytes</span> <span style=color:#cb4b16>between</span> <span style=color:#cb4b16>different</span> <span style=color:#cb4b16>objects</span> <span style=color:#cb4b16>of</span> <span style=color:#cb4b16>that</span> <span style=color:#cb4b16>map.</span>
    
    (<span style=color:#268bd2>gdb</span>) <span style=color:#cb4b16>ni</span>
    0<span style=color:#268bd2>x000056551241db47</span> <span style=color:#cb4b16>in</span> <span style=color:#cb4b16>minefield_has_mine</span> ()
    1: <span style=color:#268bd2>x</span>/<span style=color:#cb4b16>i</span> <span style=color:#cb4b16>$pc</span>
    =&gt; 0<span style=color:#268bd2>x56551241db47</span> &lt;<span style=color:#cb4b16>minefield_has_mine</span>+<span style=color:#2aa198>23</span>&gt;:	<span style=color:#cb4b16>mov</span>    <span style=color:#2aa198>0x20</span>(<span style=color:#268bd2>%rax</span>),<span style=color:#268bd2>%eax</span>
    COMMENT: <span style=color:#268bd2>$rax</span>+<span style=color:#2aa198>0x20</span> <span style=color:#cb4b16>is</span> <span style=color:#cb4b16>our</span> <span style=color:#cb4b16>cell</span>: <span style=color:#2aa198>0</span> <span style=color:#cb4b16>if</span> <span style=color:#cb4b16>empty</span>, <span style=color:#cb4b16>otherwise</span> <span style=color:#2aa198>1</span>. <span style=color:#cb4b16>Copying</span> <span style=color:#cb4b16>it</span> <span style=color:#cb4b16>to</span> <span style=color:#cb4b16>$eax</span> <span style=color:#cb4b16>and</span> <span style=color:#cb4b16>retuning</span> (<span style=color:#cb4b16>next</span> <span style=color:#cb4b16>instruction</span>) <span style=color:#cb4b16>will</span> <span style=color:#cb4b16>return</span> <span style=color:#cb4b16>this</span> <span style=color:#cb4b16>value.</span>
    
    (<span style=color:#268bd2>gdb</span>) <span style=color:#cb4b16>ni</span>
    0<span style=color:#268bd2>x000056551241db4a</span> <span style=color:#cb4b16>in</span> <span style=color:#cb4b16>minefield_has_mine</span> ()
    1: <span style=color:#268bd2>x</span>/<span style=color:#cb4b16>i</span> <span style=color:#cb4b16>$pc</span>
    =&gt; 0<span style=color:#268bd2>x56551241db4a</span> &lt;<span style=color:#cb4b16>minefield_has_mine</span>+<span style=color:#2aa198>26</span>&gt;:	<span style=color:#cb4b16>retq</span></code></pre></div>
<p><img loading=lazy src=/mines_explained.png alt="mines explained">
Now the job is to translate that assembly code to C language, which is quite straightforward. My code uses the initial heap address and loops the whole range looking for the [row, column, mine]. Then, we need to use the same offsets to access the map.</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp>    base frame <span style=color:#719e07>=</span> {stoi(argv[<span style=color:#2aa198>2</span>]), stoi(argv[<span style=color:#2aa198>3</span>]), stoi(argv[<span style=color:#2aa198>4</span>])};
    <span style=color:#719e07>auto</span> address <span style=color:#719e07>=</span> search_memory(fd, addresses, frame);
    <span style=color:#719e07>if</span> (address <span style=color:#719e07>==</span> <span style=color:#2aa198>0</span>) {
        cerr <span style=color:#719e07>&lt;&lt;</span> <span style=color:#2aa198>&#34;cannot find the board in memory.</span><span style=color:#cb4b16>\n</span><span style=color:#2aa198>&#34;</span>;
        <span style=color:#719e07>return</span> <span style=color:#2aa198>4</span>;
    }
    
    pread(fd, <span style=color:#719e07>&amp;</span>location, <span style=color:#719e07>sizeof</span>(<span style=color:#dc322f>uint64_t</span>), <span style=color:#719e07>static_cast</span><span style=color:#719e07>&lt;</span>off_t<span style=color:#719e07>&gt;</span>(address <span style=color:#719e07>+</span> <span style=color:#2aa198>0x30</span>));
    pread(fd, <span style=color:#719e07>&amp;</span>mine_pos, <span style=color:#719e07>sizeof</span>(<span style=color:#dc322f>int32_t</span>), <span style=color:#719e07>static_cast</span><span style=color:#719e07>&lt;</span>off_t<span style=color:#719e07>&gt;</span>(address <span style=color:#719e07>+</span> <span style=color:#2aa198>0x3c</span>));
    
    <span style=color:#719e07>for</span> (<span style=color:#dc322f>int</span> i <span style=color:#719e07>=</span> <span style=color:#2aa198>0</span>; i <span style=color:#719e07>&lt;</span> frame.height; <span style=color:#719e07>++</span>i) {
        <span style=color:#719e07>for</span> (<span style=color:#dc322f>int</span> j <span style=color:#719e07>=</span> <span style=color:#2aa198>0</span>; j <span style=color:#719e07>&lt;</span> frame.width; <span style=color:#719e07>++</span>j) {
            <span style=color:#719e07>auto</span> index <span style=color:#719e07>=</span> <span style=color:#2aa198>8</span> <span style=color:#719e07>*</span> (mine_pos <span style=color:#719e07>*</span> j <span style=color:#719e07>+</span> i);
            pread(fd, <span style=color:#719e07>&amp;</span>has_mine_p, <span style=color:#719e07>sizeof</span>(<span style=color:#dc322f>uint64_t</span>),
                    <span style=color:#719e07>static_cast</span><span style=color:#719e07>&lt;</span>off_t<span style=color:#719e07>&gt;</span>((location <span style=color:#719e07>+</span> index)));
            pread(fd, <span style=color:#719e07>&amp;</span>has_mine, <span style=color:#719e07>sizeof</span>(<span style=color:#dc322f>int32_t</span>),
                    <span style=color:#719e07>static_cast</span><span style=color:#719e07>&lt;</span>off_t<span style=color:#719e07>&gt;</span>(has_mine_p <span style=color:#719e07>+</span> <span style=color:#2aa198>0x20</span>));
            cout <span style=color:#719e07>&lt;&lt;</span> has_mine <span style=color:#719e07>&lt;&lt;</span> <span style=color:#2aa198>&#34; &#34;</span>;
        }
        cout <span style=color:#719e07>&lt;&lt;</span> endl;
    }</code></pre></div>
<h3 id=how-to-use-it>How to use it<a hidden class=anchor aria-hidden=true href=#how-to-use-it>#</a></h3>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console>    % g++ -std=c++17 -g3 mines.cpp -o mines
    % gnome-mines&amp;
    [1] 13264
    
    % ./mines 13264 16 16 40
    0 0 0 0 0 0 1 0 0 0 0 0 0 1 0 0
    0 0 0 0 0 0 0 0 0 0 0 0 0 1 1 0
    1 1 0 0 0 0 0 0 1 0 1 0 0 1 0 1
    1 0 0 0 0 0 0 1 0 1 0 0 0 1 0 0
    1 0 0 1 0 1 0 0 0 1 0 1 0 0 0 1
    0 0 1 1 0 0 0 0 0 0 0 0 0 0 0 1
    0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0
    0 0 0 0 1 0 1 1 0 0 0 0 0 0 0 0
    0 0 1 0 0 0 0 1 0 0 0 0 0 0 0 0
    0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0
    0 0 0 1 0 1 0 0 0 0 1 0 1 0 0 0
    0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0
    0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0
    0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0
    0 0 0 0 0 0 0 0 0 0 1 0 0 1 0 0
    0 0 0 0 0 0 0 0 0 1 1 0 0 0 0 0
</code></pre></div>
<p><img loading=lazy src=/mines_final.png alt="mines final">
</p>
</div>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=https://jrziviani.github.io/tags/c++/>C++</a></li>
<li><a href=https://jrziviani.github.io/tags/hacking/>hacking</a></li>
<li><a href=https://jrziviani.github.io/tags/linux/>linux</a></li>
</ul>
<nav class=paginav>
<a class=prev href=https://jrziviani.github.io/2018/touching-around/>
<span class=title>« Prev Page</span>
<br>
<span>Touching Around</span>
</a>
<a class=next href=https://jrziviani.github.io/2017/cppcon-2017/>
<span class=title>Next Page »</span>
<br>
<span>CPPCon 2017</span>
</a>
</nav>
</footer>
</article>
</main>
<footer class=footer>
<span>&copy; 2022 <a href=https://jrziviani.github.io>ziviani.net</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
</body>
</html>
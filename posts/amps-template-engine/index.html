<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>Amps Template Engine | ziviani.net</title>
<meta name=keywords content="C++">
<meta name=description content="Amps template engine for C++17.">
<meta name=author content="Jose R. Ziviani">
<link rel=canonical href=https://ziviani.net/posts/amps-template-engine/>
<link crossorigin=anonymous href=/assets/css/stylesheet.min.c88963fe2d79462000fd0fb1b3737783c32855d340583e4523343f8735c787f0.css integrity="sha256-yIlj/i15RiAA/Q+xs3N3g8MoVdNAWD5FIzQ/hzXHh/A=" rel="preload stylesheet" as=style>
<link rel=icon href=https://ziviani.net/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://ziviani.net/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://ziviani.net/favicon-32x32.png>
<link rel=apple-touch-icon href=https://ziviani.net/apple-touch-icon.png>
<link rel=mask-icon href=https://ziviani.net/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.92.0">
<link rel=alternate hreflang=en href=https://ziviani.net/posts/amps-template-engine/>
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript><meta property="og:title" content="Amps Template Engine">
<meta property="og:description" content="Amps template engine for C++17.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://ziviani.net/posts/amps-template-engine/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2019-01-08T17:20:19-08:00">
<meta property="article:modified_time" content="2019-01-08T17:20:19-08:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Amps Template Engine">
<meta name=twitter:description content="Amps template engine for C++17.">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://ziviani.net/posts/"},{"@type":"ListItem","position":2,"name":"Amps Template Engine","item":"https://ziviani.net/posts/amps-template-engine/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Amps Template Engine","name":"Amps Template Engine","description":"Amps template engine for C++17.","keywords":["C++"],"articleBody":"Amps is my new toy project. I’ve been writing it after reading the Crafting Interpreters, an excellent book by the way. Amps is a simple text template engine (under development, of course) developed in C++17.\nAs a side note, I’m impressed with modern C++ expressiveness. Despite of critics that I’ve read recently, it’s becoming a lot easier than old C++. Features like optional and variant give us the power to compose different types in order to create type safe complex structures, almost like dynamically type languages do.\nFor instance:\namps::user_map ht { {\"name\", \"My name\"}, {\"cities\", vector{ \"Sao Paulo\", \"Paris\", \"NYC\", \"London\", \"Lisbon\"}}, {\"songs\", unordered_map{ {\"guns and roses\", \"patience\"}, {\"aerosmith\", \"crazy\"}, {\"led zeppelin\", \"immigrant song\"}, {\"pink floyd\", \"high hopes\"}}}, }; Isn’t it somewhat similar to Python?\nht = { \"name\": \"My name\", \"cities\": [\"Sao Paulo\", \"Paris\"], \"songs\": {\"aerosmith\": \"crazy\"}} To make Amps more useful I’ve integrated it to a module for Apache HTTP server. It basically offers dynamic web pages without a real programming language (like PHP, Ruby, Python) behind it. This could be good for small projects, however I’ve not measure the performance yet.\nIn order to build Apache’s HTTPd I referred to my old post. Then, I wrote a wrapper to connect my C++17 project with an plain C Apache module and nothing else.\n$ cat amps_wrapper.cpp  1 #ifdef __cplusplus 2 3 #include \"engine.h\"4 5 #include \"httpd.h\"6 7 #include 8 #include 9 #include 10 #include 11 12 using std::vector; 13 using std::string; 14 using std::unordered_map; 15 16 unordered_mapstring, string query_to_map(const char *query) 17 { 18 unordered_mapstring, string result; 19 if (query == nullptr) { 20 return result; 21 } 22 23 char *tmp = strdup(query); 24 for (char *tok = strtok(tmp, \"\u0026\"); tok != NULL; tok = strtok(NULL, \"\u0026\")) { 25 char *value = strchr(tok, '='); 26 if (value == nullptr) { 27 continue; 28 } 29 30 result[string(tok, value - tok)] = string(\u0026value[1]); 31 } 32 33 free(tmp); 34 return result; 35 } 36 37 static void get_custom_template(request_rec *r, char **result) 38 { 39 if (r-args == 0) { 40 return; 41 } 42 43 amps::error err; 44 amps::engine engine(err); 45 engine.set_template_directory(\"/tmp\"); 46 47 amps::user_map ht {{\"user_data\", query_to_map(r-args)}}; 48 49 // html template is the default, xml returned when content=xml 50 auto content = user.find(\"content\"); 51 if (content == user.end() || content-second == \"html\") { 52 engine.prepare_template(\"template.tpl\"); 53 r-content_type = \"text/html\"; 54 } 55 else { 56 engine.prepare_template(\"template_xml.tpl\"); 57 r-content_type = \"text/xml\"; 58 } 59 string rendered = engine.render(ht); 60 61 *result = (char*)malloc(sizeof(char) * rendered.size() + 1); 62 strcpy(*result, rendered.c_str()); 63 (*result)[rendered.size()] = '\\0'; 64 } 65 #endif 66 67 extern \"C\" { 68 #include \"amps_wrapper.h\"69 70 void get_template(request_rec *r, char **result) 71 { 72 get_custom_template(r, result); 73 } 74 } The HTTPd module simply calls the get_template function.\n1 static int get_handler(request_rec *r) 2 { 3 char *result = NULL; 4 5 if (r-header_only || r-args == 0) { 6 return OK; 7 } 8 9 get_template(r, \u0026result); 10 11 /* something bad happened */ 12 if (result == NULL) { 13 return DECLINED; 14 } 15 16 ap_rputs(result, r); 17 18 free(result); 19 20 return OK; 21 } I compile it all with:\n$ g++ -std=c++17 -I/home/ziviani/amps/include \\ -I/home/ziviani/httpd/www/include \\ -fPIC amps_wrapper.cpp -o wrapper.o -c -g3 $ ../bin/apxs -I/home/ziviani/amps/include -c -i mod_cool_framework.c wrapper.o libamps-static.a  And I finally get this (html template):\n1 html 2 head 3 meta charset=\"utf-8\" 4 head 5 6 body 7 h2Welcome {= user_data[\"name\"] =}h2 8 ul 9 liALL DATA:ul 10 {% for key, value in user_data %} 11 {% if value eq \"null\" %} 12 liops, something wrong hereli 13 {% else %} 14 li{= value =}li 15 {% endif %} 16 {% endfor %} 17 ul 18 body 19 html and this (xml template):\n1  2 {= user_data[\"name\"] =} 3  Amps is at its initial stage but it’s been very fun to develop. I intend to continue writing about it in the near future.\nThank you for reading it.\n","wordCount":"662","inLanguage":"en","datePublished":"2019-01-08T17:20:19-08:00","dateModified":"2019-01-08T17:20:19-08:00","author":{"@type":"Person","name":"Jose R. Ziviani"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://ziviani.net/posts/amps-template-engine/"},"publisher":{"@type":"Organization","name":"ziviani.net","logo":{"@type":"ImageObject","url":"https://ziviani.net/favicon.ico"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://ziviani.net/ accesskey=h title="ziviani.net (Alt + H)">ziviani.net</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
<ul class=lang-switch><li>|</li>
<li>
<a href=https://ziviani.net/pt/ title=Portuguese aria-label=:pt:>Pt</a>
</li>
</ul>
</span>
</div>
<ul id=menu>
<li>
<a href=https://ziviani.net/archives title=Archive>
<span>Archive</span>
</a>
</li>
<li>
<a href=https://ziviani.net/search title="Search (Alt + /)" accesskey=/>
<span>Search</span>
</a>
</li>
<li>
<a href=https://ziviani.net/tags title=Tags>
<span>Tags</span>
</a>
</li>
<li>
<a href=https://ziviani.net/about title=About>
<span>About</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<div class=breadcrumbs><a href=https://ziviani.net/>Home</a>&nbsp;»&nbsp;<a href=https://ziviani.net/posts/>Posts</a></div>
<h1 class=post-title>
Amps Template Engine
</h1>
<div class=post-meta><span title="2019-01-08 17:20:19 -0800 -0800">January 8, 2019</span>&nbsp;·&nbsp;4 min&nbsp;·&nbsp;Jose R. Ziviani
</div>
</header>
<div class=post-content><p><a href=https://github.com/jrziviani/amps>Amps</a> is my new toy project. I&rsquo;ve been writing it after reading the <a href=http://craftinginterpreters.com/>Crafting Interpreters</a>, an excellent book by the way. Amps is a simple text template engine (under development, of course) developed in C++17.</p>
<p>As a side note, I&rsquo;m impressed with modern C++ expressiveness. Despite of critics that I&rsquo;ve read recently, it&rsquo;s becoming a lot easier than old C++. Features like <code>optional</code> and <code>variant</code> give us the power to compose different types in order to create type safe complex structures, almost like dynamically type languages do.</p>
<p>For instance:</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp>    amps<span style=color:#719e07>::</span>user_map ht {
      {<span style=color:#2aa198>&#34;name&#34;</span>, <span style=color:#2aa198>&#34;My name&#34;</span>},
      {<span style=color:#2aa198>&#34;cities&#34;</span>, vector{
             <span style=color:#2aa198>&#34;Sao Paulo&#34;</span>,
             <span style=color:#2aa198>&#34;Paris&#34;</span>,
             <span style=color:#2aa198>&#34;NYC&#34;</span>,
             <span style=color:#2aa198>&#34;London&#34;</span>,
             <span style=color:#2aa198>&#34;Lisbon&#34;</span>}},
      {<span style=color:#2aa198>&#34;songs&#34;</span>, unordered_map{
            {<span style=color:#2aa198>&#34;guns and roses&#34;</span>, <span style=color:#2aa198>&#34;patience&#34;</span>},
            {<span style=color:#2aa198>&#34;aerosmith&#34;</span>, <span style=color:#2aa198>&#34;crazy&#34;</span>},
            {<span style=color:#2aa198>&#34;led zeppelin&#34;</span>, <span style=color:#2aa198>&#34;immigrant song&#34;</span>},
            {<span style=color:#2aa198>&#34;pink floyd&#34;</span>, <span style=color:#2aa198>&#34;high hopes&#34;</span>}}},
    };</code></pre></div>
<p>Isn&rsquo;t it somewhat similar to Python?</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>    ht <span style=color:#719e07>=</span> {
        <span style=color:#2aa198>&#34;name&#34;</span>: <span style=color:#2aa198>&#34;My name&#34;</span>,
        <span style=color:#2aa198>&#34;cities&#34;</span>: [<span style=color:#2aa198>&#34;Sao Paulo&#34;</span>, <span style=color:#2aa198>&#34;Paris&#34;</span>],
        <span style=color:#2aa198>&#34;songs&#34;</span>: {<span style=color:#2aa198>&#34;aerosmith&#34;</span>: <span style=color:#2aa198>&#34;crazy&#34;</span>}}</code></pre></div>
<p>To make Amps more useful I&rsquo;ve integrated it to a module for <a href=https://httpd.apache.org/>Apache HTTP server</a>. It basically offers dynamic web pages without a real programming language (like PHP, Ruby, Python) behind it. This could be good for small projects, however I&rsquo;ve not measure the performance yet.</p>
<p>In order to build Apache&rsquo;s HTTPd I referred to my <a href=https://ziviani.net/2011/how-to-create-an-apache-module>old post</a>. Then, I wrote a wrapper to connect my C++17 project with an plain C Apache module and nothing else.</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console>    $ cat amps_wrapper.cpp
</code></pre></div>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 1</span>    <span style=color:#719e07>#ifdef __cplusplus
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 2</span><span style=color:#719e07></span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 3</span>    <span style=color:#719e07>#include</span> <span style=color:#719e07>&#34;engine.h&#34;</span><span style=color:#719e07>
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 4</span><span style=color:#719e07></span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 5</span>    <span style=color:#719e07>#include</span> <span style=color:#719e07>&#34;httpd.h&#34;</span><span style=color:#719e07>
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 6</span><span style=color:#719e07></span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 7</span>    <span style=color:#719e07>#include</span> <span style=color:#719e07>&lt;unordered_map&gt;</span><span style=color:#719e07>
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 8</span><span style=color:#719e07></span>    <span style=color:#719e07>#include</span> <span style=color:#719e07>&lt;vector&gt;</span><span style=color:#719e07>
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 9</span><span style=color:#719e07></span>    <span style=color:#719e07>#include</span> <span style=color:#719e07>&lt;string&gt;</span><span style=color:#719e07>
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">10</span><span style=color:#719e07></span>    <span style=color:#719e07>#include</span> <span style=color:#719e07>&lt;cstring&gt;</span><span style=color:#719e07>
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">11</span><span style=color:#719e07></span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050">12</span>    <span style=color:#719e07>using</span> std<span style=color:#719e07>::</span>vector;
<span style="margin-right:.4em;padding:0 .4em;color:#495050">13</span>    <span style=color:#719e07>using</span> std<span style=color:#719e07>::</span>string;
<span style="margin-right:.4em;padding:0 .4em;color:#495050">14</span>    <span style=color:#719e07>using</span> std<span style=color:#719e07>::</span>unordered_map;
<span style="margin-right:.4em;padding:0 .4em;color:#495050">15</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050">16</span>    unordered_map<span style=color:#719e07>&lt;</span>string, string<span style=color:#719e07>&gt;</span> query_to_map(<span style=color:#719e07>const</span> <span style=color:#dc322f>char</span> <span style=color:#719e07>*</span>query)
<span style="margin-right:.4em;padding:0 .4em;color:#495050">17</span>    {
<span style="margin-right:.4em;padding:0 .4em;color:#495050">18</span>        unordered_map<span style=color:#719e07>&lt;</span>string, string<span style=color:#719e07>&gt;</span> result;
<span style="margin-right:.4em;padding:0 .4em;color:#495050">19</span>        <span style=color:#719e07>if</span> (query <span style=color:#719e07>==</span> <span style=color:#719e07>nullptr</span>) {
<span style="margin-right:.4em;padding:0 .4em;color:#495050">20</span>            <span style=color:#719e07>return</span> result;
<span style="margin-right:.4em;padding:0 .4em;color:#495050">21</span>        }
<span style="margin-right:.4em;padding:0 .4em;color:#495050">22</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050">23</span>        <span style=color:#dc322f>char</span> <span style=color:#719e07>*</span>tmp <span style=color:#719e07>=</span> strdup(query);
<span style="margin-right:.4em;padding:0 .4em;color:#495050">24</span>        <span style=color:#719e07>for</span> (<span style=color:#dc322f>char</span> <span style=color:#719e07>*</span>tok <span style=color:#719e07>=</span> strtok(tmp, <span style=color:#2aa198>&#34;&amp;&#34;</span>); tok <span style=color:#719e07>!=</span> <span style=color:#b58900>NULL</span>; tok <span style=color:#719e07>=</span> strtok(<span style=color:#b58900>NULL</span>, <span style=color:#2aa198>&#34;&amp;&#34;</span>)) {
<span style="margin-right:.4em;padding:0 .4em;color:#495050">25</span>            <span style=color:#dc322f>char</span> <span style=color:#719e07>*</span>value <span style=color:#719e07>=</span> strchr(tok, <span style=color:#2aa198>&#39;=&#39;</span>);
<span style="margin-right:.4em;padding:0 .4em;color:#495050">26</span>            <span style=color:#719e07>if</span> (value <span style=color:#719e07>==</span> <span style=color:#719e07>nullptr</span>) {
<span style="margin-right:.4em;padding:0 .4em;color:#495050">27</span>                <span style=color:#719e07>continue</span>;
<span style="margin-right:.4em;padding:0 .4em;color:#495050">28</span>            }
<span style="margin-right:.4em;padding:0 .4em;color:#495050">29</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050">30</span>            result[string(tok, value <span style=color:#719e07>-</span> tok)] <span style=color:#719e07>=</span> string(<span style=color:#719e07>&amp;</span>value[<span style=color:#2aa198>1</span>]);
<span style="margin-right:.4em;padding:0 .4em;color:#495050">31</span>        }
<span style="margin-right:.4em;padding:0 .4em;color:#495050">32</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050">33</span>        free(tmp);
<span style="margin-right:.4em;padding:0 .4em;color:#495050">34</span>        <span style=color:#719e07>return</span> result;
<span style="margin-right:.4em;padding:0 .4em;color:#495050">35</span>    }
<span style="margin-right:.4em;padding:0 .4em;color:#495050">36</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050">37</span>    <span style=color:#719e07>static</span> <span style=color:#dc322f>void</span> <span style=color:#268bd2>get_custom_template</span>(request_rec <span style=color:#719e07>*</span>r, <span style=color:#dc322f>char</span> <span style=color:#719e07>**</span>result)
<span style="margin-right:.4em;padding:0 .4em;color:#495050">38</span>    {
<span style="margin-right:.4em;padding:0 .4em;color:#495050">39</span>        <span style=color:#719e07>if</span> (r<span style=color:#719e07>-&gt;</span>args <span style=color:#719e07>==</span> <span style=color:#2aa198>0</span>) {
<span style="margin-right:.4em;padding:0 .4em;color:#495050">40</span>            <span style=color:#719e07>return</span>;
<span style="margin-right:.4em;padding:0 .4em;color:#495050">41</span>        }
<span style="margin-right:.4em;padding:0 .4em;color:#495050">42</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050">43</span>        amps<span style=color:#719e07>::</span>error err;
<span style="margin-right:.4em;padding:0 .4em;color:#495050">44</span>        amps<span style=color:#719e07>::</span>engine engine(err);
<span style="margin-right:.4em;padding:0 .4em;color:#495050">45</span>        engine.set_template_directory(<span style=color:#2aa198>&#34;/tmp&#34;</span>);
<span style="margin-right:.4em;padding:0 .4em;color:#495050">46</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050">47</span>        amps<span style=color:#719e07>::</span>user_map ht {{<span style=color:#2aa198>&#34;user_data&#34;</span>, query_to_map(r<span style=color:#719e07>-&gt;</span>args)}};
<span style="margin-right:.4em;padding:0 .4em;color:#495050">48</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050">49</span>        <span style=color:#586e75>// html template is the default, xml returned when content=xml
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">50</span><span style=color:#586e75></span>        <span style=color:#719e07>auto</span> content <span style=color:#719e07>=</span> user.find(<span style=color:#2aa198>&#34;content&#34;</span>);
<span style="margin-right:.4em;padding:0 .4em;color:#495050">51</span>        <span style=color:#719e07>if</span> (content <span style=color:#719e07>==</span> user.end() <span style=color:#719e07>||</span> content<span style=color:#719e07>-&gt;</span>second <span style=color:#719e07>==</span> <span style=color:#2aa198>&#34;html&#34;</span>) {
<span style="margin-right:.4em;padding:0 .4em;color:#495050">52</span>            engine.prepare_template(<span style=color:#2aa198>&#34;template.tpl&#34;</span>);
<span style="margin-right:.4em;padding:0 .4em;color:#495050">53</span>            r<span style=color:#719e07>-&gt;</span>content_type <span style=color:#719e07>=</span> <span style=color:#2aa198>&#34;text/html&#34;</span>;
<span style="margin-right:.4em;padding:0 .4em;color:#495050">54</span>        }
<span style="margin-right:.4em;padding:0 .4em;color:#495050">55</span>        <span style=color:#719e07>else</span> {
<span style="margin-right:.4em;padding:0 .4em;color:#495050">56</span>            engine.prepare_template(<span style=color:#2aa198>&#34;template_xml.tpl&#34;</span>);
<span style="margin-right:.4em;padding:0 .4em;color:#495050">57</span>            r<span style=color:#719e07>-&gt;</span>content_type <span style=color:#719e07>=</span> <span style=color:#2aa198>&#34;text/xml&#34;</span>;
<span style="margin-right:.4em;padding:0 .4em;color:#495050">58</span>        }
<span style="margin-right:.4em;padding:0 .4em;color:#495050">59</span>        string rendered <span style=color:#719e07>=</span> engine.render(ht);
<span style="margin-right:.4em;padding:0 .4em;color:#495050">60</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050">61</span>        <span style=color:#719e07>*</span>result <span style=color:#719e07>=</span> (<span style=color:#dc322f>char</span><span style=color:#719e07>*</span>)malloc(<span style=color:#719e07>sizeof</span>(<span style=color:#dc322f>char</span>) <span style=color:#719e07>*</span> rendered.size() <span style=color:#719e07>+</span> <span style=color:#2aa198>1</span>);
<span style="margin-right:.4em;padding:0 .4em;color:#495050">62</span>        strcpy(<span style=color:#719e07>*</span>result, rendered.c_str());
<span style="margin-right:.4em;padding:0 .4em;color:#495050">63</span>        (<span style=color:#719e07>*</span>result)[rendered.size()] <span style=color:#719e07>=</span> <span style=color:#2aa198>&#39;\0&#39;</span>;
<span style="margin-right:.4em;padding:0 .4em;color:#495050">64</span>    }
<span style="margin-right:.4em;padding:0 .4em;color:#495050">65</span>    <span style=color:#719e07>#endif
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">66</span><span style=color:#719e07></span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050">67</span>    <span style=color:#719e07>extern</span> <span style=color:#2aa198>&#34;C&#34;</span> {
<span style="margin-right:.4em;padding:0 .4em;color:#495050">68</span>        <span style=color:#719e07>#include</span> <span style=color:#719e07>&#34;amps_wrapper.h&#34;</span><span style=color:#719e07>
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">69</span><span style=color:#719e07></span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050">70</span>        <span style=color:#dc322f>void</span> <span style=color:#268bd2>get_template</span>(request_rec <span style=color:#719e07>*</span>r, <span style=color:#dc322f>char</span> <span style=color:#719e07>**</span>result)
<span style="margin-right:.4em;padding:0 .4em;color:#495050">71</span>        {
<span style="margin-right:.4em;padding:0 .4em;color:#495050">72</span>            get_custom_template(r, result);
<span style="margin-right:.4em;padding:0 .4em;color:#495050">73</span>        }
<span style="margin-right:.4em;padding:0 .4em;color:#495050">74</span>    }</code></pre></div>
<p>The HTTPd module simply calls the <code>get_template</code> function.</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 1</span>    <span style=color:#719e07>static</span> <span style=color:#dc322f>int</span> <span style=color:#268bd2>get_handler</span>(request_rec <span style=color:#719e07>*</span>r)
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 2</span>    {
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 3</span>        <span style=color:#dc322f>char</span> <span style=color:#719e07>*</span>result <span style=color:#719e07>=</span> <span style=color:#b58900>NULL</span>;
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 4</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 5</span>        <span style=color:#719e07>if</span> (r<span style=color:#719e07>-&gt;</span>header_only <span style=color:#719e07>||</span> r<span style=color:#719e07>-&gt;</span>args <span style=color:#719e07>==</span> <span style=color:#2aa198>0</span>) {
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 6</span>            <span style=color:#719e07>return</span> OK;
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 7</span>        }
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 8</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 9</span>        get_template(r, <span style=color:#719e07>&amp;</span>result);
<span style="margin-right:.4em;padding:0 .4em;color:#495050">10</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050">11</span>        <span style=color:#586e75>/* something bad happened */</span>
<span style="margin-right:.4em;padding:0 .4em;color:#495050">12</span>        <span style=color:#719e07>if</span> (result <span style=color:#719e07>==</span> <span style=color:#b58900>NULL</span>) {
<span style="margin-right:.4em;padding:0 .4em;color:#495050">13</span>            <span style=color:#719e07>return</span> DECLINED;
<span style="margin-right:.4em;padding:0 .4em;color:#495050">14</span>        }
<span style="margin-right:.4em;padding:0 .4em;color:#495050">15</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050">16</span>        ap_rputs(result, r);
<span style="margin-right:.4em;padding:0 .4em;color:#495050">17</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050">18</span>        free(result);
<span style="margin-right:.4em;padding:0 .4em;color:#495050">19</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050">20</span>        <span style=color:#719e07>return</span> OK;
<span style="margin-right:.4em;padding:0 .4em;color:#495050">21</span>    }</code></pre></div>
<p>I compile it all with:</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console>    $ g++ -std=c++17 -I/home/ziviani/amps/include \
     -I/home/ziviani/httpd/www/include \
     -fPIC amps_wrapper.cpp -o wrapper.o -c -g3
    $ ../bin/apxs  -I/home/ziviani/amps/include -c -i mod_cool_framework.c wrapper.o libamps-static.a
</code></pre></div>
<p>And I finally get this (html template):</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 1</span>    &lt;<span style=color:#268bd2>html</span>&gt;
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 2</span>        &lt;<span style=color:#268bd2>head</span>&gt;
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 3</span>            &lt;<span style=color:#268bd2>meta</span> charset<span style=color:#719e07>=</span><span style=color:#2aa198>&#34;utf-8&#34;</span>&gt;
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 4</span>        &lt;<span style=color:#268bd2>head</span>&gt;
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 5</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 6</span>        &lt;<span style=color:#268bd2>body</span>&gt;
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 7</span>            &lt;<span style=color:#268bd2>h2</span>&gt;Welcome {= user_data[&#34;name&#34;] =}&lt;<span style=color:#268bd2>h2</span>&gt;
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 8</span>            &lt;<span style=color:#268bd2>ul</span>&gt;
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 9</span>                &lt;<span style=color:#268bd2>li</span>&gt;ALL DATA:&lt;<span style=color:#268bd2>ul</span>&gt;
<span style="margin-right:.4em;padding:0 .4em;color:#495050">10</span>                {% for key, value in user_data %}
<span style="margin-right:.4em;padding:0 .4em;color:#495050">11</span>                    {% if value eq &#34;&lt;<span style=color:#268bd2>null</span>&gt;&#34; %}
<span style="margin-right:.4em;padding:0 .4em;color:#495050">12</span>                        &lt;<span style=color:#268bd2>li</span>&gt;ops, something wrong here&lt;<span style=color:#268bd2>li</span>&gt;
<span style="margin-right:.4em;padding:0 .4em;color:#495050">13</span>                    {% else %}
<span style="margin-right:.4em;padding:0 .4em;color:#495050">14</span>                        &lt;<span style=color:#268bd2>li</span>&gt;{= value =}&lt;<span style=color:#268bd2>li</span>&gt;
<span style="margin-right:.4em;padding:0 .4em;color:#495050">15</span>                    {% endif %}
<span style="margin-right:.4em;padding:0 .4em;color:#495050">16</span>                {% endfor %}
<span style="margin-right:.4em;padding:0 .4em;color:#495050">17</span>            &lt;<span style=color:#268bd2>ul</span>&gt;
<span style="margin-right:.4em;padding:0 .4em;color:#495050">18</span>        &lt;<span style=color:#268bd2>body</span>&gt;
<span style="margin-right:.4em;padding:0 .4em;color:#495050">19</span>    &lt;<span style=color:#268bd2>html</span>&gt;</code></pre></div>
<p><img loading=lazy src=/amps_html.png alt="amps html content">
</p>
<p>and this (xml template):</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style="margin-right:.4em;padding:0 .4em;color:#495050">1</span>    <span style=color:#268bd2>&lt;xml&gt;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#495050">2</span>        <span style=color:#268bd2>&lt;user_name&gt;</span>{= user_data[&#34;name&#34;] =}<span style=color:#268bd2>&lt;/user_name&gt;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#495050">3</span>    <span style=color:#268bd2>&lt;/xml&gt;</span></code></pre></div>
<p><img loading=lazy src=/amps_xml.png alt="amps xml content">
</p>
<p>Amps is at its initial stage but it&rsquo;s been very fun to develop. I intend to continue writing about it in the near future.</p>
<p>Thank you for reading it.</p>
</div>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=https://ziviani.net/tags/c++/>C++</a></li>
</ul>
<nav class=paginav>
<a class=next href=https://ziviani.net/posts/linux-crash-tool-part-i/>
<span class=title>Next Page »</span>
<br>
<span>Linux Crash Tool Part I</span>
</a>
</nav>
</footer>
</article>
</main>
<footer class=footer>
<span>&copy; 2022 <a href=https://ziviani.net/>ziviani.net</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
</body>
</html>
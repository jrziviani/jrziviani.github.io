<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>Elegant Visitors | ziviani.net</title>
<meta name=keywords content="C++,design patterns,OO">
<meta name=description content="Exploring the powerful visitor design pattern.">
<meta name=author content="Jose R. Ziviani">
<link rel=canonical href=https://ziviani.net/posts/elegant-visitors/>
<link crossorigin=anonymous href=/assets/css/stylesheet.min.c88963fe2d79462000fd0fb1b3737783c32855d340583e4523343f8735c787f0.css integrity="sha256-yIlj/i15RiAA/Q+xs3N3g8MoVdNAWD5FIzQ/hzXHh/A=" rel="preload stylesheet" as=style>
<link rel=icon href=https://ziviani.net/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://ziviani.net/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://ziviani.net/favicon-32x32.png>
<link rel=apple-touch-icon href=https://ziviani.net/apple-touch-icon.png>
<link rel=mask-icon href=https://ziviani.net/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.92.0">
<link rel=alternate hreflang=en href=https://ziviani.net/posts/elegant-visitors/>
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript><meta property="og:title" content="Elegant Visitors">
<meta property="og:description" content="Exploring the powerful visitor design pattern.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://ziviani.net/posts/elegant-visitors/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2017-12-03T17:09:28-08:00">
<meta property="article:modified_time" content="2017-12-03T17:09:28-08:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Elegant Visitors">
<meta name=twitter:description content="Exploring the powerful visitor design pattern.">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://ziviani.net/posts/"},{"@type":"ListItem","position":2,"name":"Elegant Visitors","item":"https://ziviani.net/posts/elegant-visitors/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Elegant Visitors","name":"Elegant Visitors","description":"Exploring the powerful visitor design pattern.","keywords":["C++","design patterns","OO"],"articleBody":"The visitor design pattern is a powerful programming pattern that I was not fundamentally aware. I knew the pattern, I had seen code examples using that pattern but I hadn’t realized how powerful and elegant it is. I confess that I overlooked at it, but the description in sites/blogs/book usually makes it confusing to me. Nonetheless, I should have gone through the practical aspects of it instead of just reading the concepts…lessons learned!\nTraversing the Object Hierarchy It’s simply there in the wikipedia:\n Clients traverse the object structure and call a dispatching operation accept(visitor) on an element — that “dispatches” (delegates) the request to the “accepted visitor object”. The visitor object then performs the operation on the element (“visits the element”).\n But, I only really read it after read the excellent Crafting Interpreters book.\nThe Crafting Interpreters uses the visitor pattern to implement the abstract syntax tree (AST) where the object hierarchy (which was created during the parsing phase) is the tree. Clients (be it an interpreter, a compiler, or even something to print the AST) can traverse the tree hierarchy by “visiting” the objects. Cool.\nCoding This code is obviously based on the referred book but I only wrote parts to highlight the visitor pattern.\n1 class expression_t 2 { 3 public: 4 virtual int accept(expression_visitor \u0026v) = 0; 5 virtual ~expression_t() {} 6 }; 7 using expression = unique_ptrexpression_t; 8 9 class type_number : public expression_t 10 { 11 int value_; 12 13 public: 14 type_number(int v) : 15 value_(v) 16 { 17 } 18 19 type_number(string v) : 20 value_(stoi(v)) 21 { 22 } 23 24 int get() const 25 { 26 return value_; 27 } 28 29 int accept(expression_visitor \u0026v) 30 { 31 return v.visit_number(*this); 32 } 33 }; 34 35 class binary_expression : public expression_t 36 { 37 expression left_; 38 expression right_; 39 char oper_; 40 41 public: 42 binary_expression(expression l, 43 expression r, 44 char o) : 45 left_(move(l)), 46 right_(move(r)), 47 oper_(o) 48 { 49 } 50 51 expression_t *left() 52 { 53 return left_.get(); 54 } 55 56 expression_t *right() 57 { 58 return right_.get(); 59 } 60 61 char operation() const 62 { 63 return oper_; 64 } 65 66 int accept(expression_visitor \u0026v) 67 { 68 return v.visit_binary(*this); 69 } 70 }; Nothing special here. An abstract class with a pure virtual method called accept() and two classes implementing it. One represents numbers, other represents binary expressions like 3 * 5. The accept() simply calls a method from the visitor passing the instance of itself as argument.\n1 class expression_visitor 2 { 3 public: 4 virtual int visit_number(type_number \u0026v) = 0; 5 virtual int visit_binary(binary_expression \u0026v) = 0; 6 virtual ~expression_visitor(); 7 }; 8 9 class interpreter : public expression_visitor 10 { 11 int visit_number(type_number \u0026n) 12 { 13 return n.get(); 14 } 15 16 int visit_binary(binary_expression \u0026b) 17 { 18 int left = evaluate(b.left()); 19 int right = evaluate(b.right()); 20 21 switch (b.operation()) { 22 case '+': 23 return left + right; 24 break; 25 26 case '-': 27 return left - right; 28 break; 29 30 case '*': 31 return left * right; 32 break; 33 34 case '/': 35 return left / right; 36 break; 37 } 38 39 throw exception(); 40 } 41 42 int evaluate(expression_t *e) 43 { 44 return e-accept(*this); 45 } 46 }; Now, the visitor. The interpreter implements the visitor, giving meaning to each object that it needs to visit. Note that visit_number() returns the value stored in type_number and visit_binary() evaluates both left() and right() expressions - that can hold either type_number or other binary_expression. In other words, visit_binary() be called recursively until it finds a type_number. Isn’t it beautiful and elegant?\nFull code listing Here is the full code listing:\n1 #include 2 #include 3 #include 4 #include 5 6 using namespace std; 7 8 class type_number; 9 class type_string; 10 class binary_expression; 11 class unary_expression; 12 13 class expression_visitor 14 { 15 public: 16 virtual int visit_number(type_number \u0026v) = 0; 17 virtual int visit_binary(binary_expression \u0026v) = 0; 18 virtual ~expression_visitor() {} 19 }; 20 21 class expression_t 22 { 23 public: 24 virtual int accept(expression_visitor \u0026v) = 0; 25 virtual ~expression_t() {} 26 }; 27 using expression = unique_ptrexpression_t; 28 29 class type_number : public expression_t 30 { 31 int value_; 32 33 public: 34 type_number(int v) : 35 value_(v) 36 { 37 } 38 39 type_number(string v) : 40 value_(stoi(v)) 41 { 42 } 43 44 int get() const 45 { 46 return value_; 47 } 48 49 int accept(expression_visitor \u0026v) 50 { 51 return v.visit_number(*this); 52 } 53 }; 54 55 class binary_expression : public expression_t 56 { 57 expression left_; 58 expression right_; 59 char oper_; 60 61 public: 62 binary_expression(expression l, 63 expression r, 64 char o) : 65 left_(move(l)), 66 right_(move(r)), 67 oper_(o) 68 { 69 } 70 71 expression_t *left() 72 { 73 return left_.get(); 74 } 75 76 expression_t *right() 77 { 78 return right_.get(); 79 } 80 81 char operation() const 82 { 83 return oper_; 84 } 85 86 int accept(expression_visitor \u0026v) 87 { 88 return v.visit_binary(*this); 89 } 90 }; 91 92 class interpreter : public expression_visitor 93 { 94 int visit_number(type_number \u0026n) 95 { 96 return n.get(); 97 } 98 99 int visit_binary(binary_expression \u0026b) 100 { 101 int left = evaluate(b.left()); 102 int right = evaluate(b.right()); 103 104 switch (b.operation()) { 105 case '+': 106 return left + right; 107 break; 108 109 case '-': 110 return left - right; 111 break; 112 113 case '*': 114 return left * right; 115 break; 116 117 case '/': 118 return left / right; 119 break; 120 } 121 122 throw exception(); 123 } 124 125 int evaluate(expression_t *e) 126 { 127 return e-accept(*this); 128 } 129 130 public: 131 void compute(expression x) 132 { 133 cout  evaluate(x.get())  endl; 134 } 135 }; 136 137 class parser 138 { 139 private: 140 expression parse(string s) 141 { 142 stringstream tokens; 143 tokens  s; 144 return parse_add_sub(tokens); 145 } 146 147 expression parse_add_sub(stringstream \u0026tk) 148 { 149 expression left = parse_mult_div(tk); 150 151 while (tk.peek() == '+' || tk.peek() == '-') { 152 char operation = tk.get(); 153 expression right = parse_mult_div(tk); 154 left = make_uniquebinary_expression(move(left), 155 move(right), 156 operation); 157 } 158 159 return left; 160 } 161 162 expression parse_mult_div(stringstream \u0026tk) 163 { 164 expression left = parse_number(tk); 165 166 while (tk.peek() == '*' || tk.peek() == '/') { 167 char operation = tk.get(); 168 expression right = parse_number(tk); 169 left = make_uniquebinary_expression(move(left), 170 move(right), 171 operation); 172 } 173 174 return left; 175 } 176 177 expression parse_number(stringstream \u0026tk) 178 { 179 string sval; 180 tk  sval; 181 int value = 0; 182 183 try { 184 value = stoi(sval); 185 } 186 catch (invalid_argument \u0026e) { 187 cerr  \"expected a number, found \"  sval  endl; 188 exit(1); 189 } 190 catch (out_of_range \u0026e) { 191 cerr  \"number \"  sval  \" overflows an integer storage\"  endl; 192 exit(1); 193 } 194 195 while (tk.peek() == ' ') 196 tk.get(); 197 198 return make_uniquetype_number(value); 199 } 200 201 public: 202 expression parse_it(string s) 203 { 204 return parse(s); 205 } 206 }; 207 208 int main() 209 { 210 interpreter it; 211 parser p; 212 213 while (true) { 214 string line; 215 216 getline(cin, line); 217 if (line == \"quit\") 218 break; 219 220 it.compute(p.parse_it(line)); 221 } 222 return 0; 223 } g++ -std=c++14 -Wall -Wextra -g visitors.cpp -o visitors % ./visitors 3 * 5 + 8 - 3 20 15 * 80 / 2 + 3 * 8 624 quit  ","wordCount":"1284","inLanguage":"en","datePublished":"2017-12-03T17:09:28-08:00","dateModified":"2017-12-03T17:09:28-08:00","author":{"@type":"Person","name":"Jose R. Ziviani"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://ziviani.net/posts/elegant-visitors/"},"publisher":{"@type":"Organization","name":"ziviani.net","logo":{"@type":"ImageObject","url":"https://ziviani.net/favicon.ico"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://ziviani.net/ accesskey=h title="ziviani.net (Alt + H)">ziviani.net</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
<ul class=lang-switch><li>|</li>
<li>
<a href=https://ziviani.net/pt/ title=Portuguese aria-label=:pt:>Pt</a>
</li>
</ul>
</span>
</div>
<ul id=menu>
<li>
<a href=https://ziviani.net/archives title=Archive>
<span>Archive</span>
</a>
</li>
<li>
<a href=https://ziviani.net/search title="Search (Alt + /)" accesskey=/>
<span>Search</span>
</a>
</li>
<li>
<a href=https://ziviani.net/tags title=Tags>
<span>Tags</span>
</a>
</li>
<li>
<a href=https://ziviani.net/about title=About>
<span>About</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<div class=breadcrumbs><a href=https://ziviani.net/>Home</a>&nbsp;»&nbsp;<a href=https://ziviani.net/posts/>Posts</a></div>
<h1 class=post-title>
Elegant Visitors
</h1>
<div class=post-meta><span title="2017-12-03 17:09:28 -0800 -0800">December 3, 2017</span>&nbsp;·&nbsp;7 min&nbsp;·&nbsp;Jose R. Ziviani
</div>
</header> <div class=toc>
<details>
<summary accesskey=c title="(Alt + C)">
<span class=details>Table of Contents</span>
</summary>
<div class=inner><ul>
<li>
<a href=#traversing-the-object-hierarchy aria-label="Traversing the Object Hierarchy">Traversing the Object Hierarchy</a></li>
<li>
<a href=#coding aria-label=Coding>Coding</a></li>
<li>
<a href=#full-code-listing aria-label="Full code listing">Full code listing</a>
</li>
</ul>
</div>
</details>
</div>
<div class=post-content><p>The visitor design pattern is a powerful programming pattern that I was not fundamentally aware. I knew the pattern, I had seen code examples using that pattern but I hadn&rsquo;t realized how powerful and elegant it is. I confess that I overlooked at it, but the description in sites/blogs/book usually makes it confusing to me. Nonetheless, I should have gone through the practical aspects of it instead of <strong>just</strong> reading the concepts&mldr;lessons learned!</p>
<h3 id=traversing-the-object-hierarchy>Traversing the Object Hierarchy<a hidden class=anchor aria-hidden=true href=#traversing-the-object-hierarchy>#</a></h3>
<p>It&rsquo;s simply there in the <a href=https://en.wikipedia.org/wiki/Visitor_pattern>wikipedia</a>:</p>
<blockquote>
<p>Clients traverse the object structure and call a dispatching operation accept(visitor) on an element — that &ldquo;dispatches&rdquo; (delegates) the request to the &ldquo;accepted visitor object&rdquo;. The visitor object then performs the operation on the element (&ldquo;visits the element&rdquo;).</p>
</blockquote>
<p>But, I only <strong>really</strong> read it after read the <strong>excellent</strong> <a href=http://www.craftinginterpreters.com/>Crafting Interpreters</a> book.</p>
<p>The <a href=http://www.craftinginterpreters.com/>Crafting Interpreters</a> uses the visitor pattern to implement the <a href=https://en.wikipedia.org/wiki/Abstract_syntax_tree>abstract syntax tree (AST)</a> where the object hierarchy (which was created during the parsing phase) is the tree. Clients (be it an interpreter, a compiler, or even something to print the AST) can traverse the tree hierarchy by &ldquo;visiting&rdquo; the objects. Cool.</p>
<h3 id=coding>Coding<a hidden class=anchor aria-hidden=true href=#coding>#</a></h3>
<p>This code is obviously based on the referred book but I only wrote parts to highlight the visitor pattern.</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 1</span>    <span style=color:#719e07>class</span> <span style=color:#268bd2>expression_t</span>
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 2</span>    {
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 3</span>    <span style=color:#719e07>public</span><span style=color:#719e07>:</span>
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 4</span>        <span style=color:#719e07>virtual</span> <span style=color:#dc322f>int</span> accept(expression_visitor <span style=color:#719e07>&amp;</span>v) <span style=color:#719e07>=</span> <span style=color:#2aa198>0</span>;
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 5</span>        <span style=color:#719e07>virtual</span> <span style=color:#719e07>~</span>expression_t() {}
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 6</span>    };
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 7</span>    <span style=color:#719e07>using</span> expression <span style=color:#719e07>=</span> unique_ptr<span style=color:#719e07>&lt;</span>expression_t<span style=color:#719e07>&gt;</span>;
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 8</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 9</span>    <span style=color:#719e07>class</span> <span style=color:#268bd2>type_number</span> <span style=color:#719e07>:</span> <span style=color:#719e07>public</span> expression_t
<span style="margin-right:.4em;padding:0 .4em;color:#495050">10</span>    {
<span style="margin-right:.4em;padding:0 .4em;color:#495050">11</span>        <span style=color:#dc322f>int</span> value_;
<span style="margin-right:.4em;padding:0 .4em;color:#495050">12</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050">13</span>    <span style=color:#719e07>public</span><span style=color:#719e07>:</span>
<span style="margin-right:.4em;padding:0 .4em;color:#495050">14</span>        type_number(<span style=color:#dc322f>int</span> v) <span style=color:#719e07>:</span>
<span style="margin-right:.4em;padding:0 .4em;color:#495050">15</span>            value_(v)
<span style="margin-right:.4em;padding:0 .4em;color:#495050">16</span>        {
<span style="margin-right:.4em;padding:0 .4em;color:#495050">17</span>        }
<span style="margin-right:.4em;padding:0 .4em;color:#495050">18</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050">19</span>        type_number(string v) <span style=color:#719e07>:</span>
<span style="margin-right:.4em;padding:0 .4em;color:#495050">20</span>            value_(stoi(v))
<span style="margin-right:.4em;padding:0 .4em;color:#495050">21</span>        {
<span style="margin-right:.4em;padding:0 .4em;color:#495050">22</span>        }
<span style="margin-right:.4em;padding:0 .4em;color:#495050">23</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050">24</span>        <span style=color:#dc322f>int</span> <span style=color:#268bd2>get</span>() <span style=color:#719e07>const</span>
<span style="margin-right:.4em;padding:0 .4em;color:#495050">25</span>        {
<span style="margin-right:.4em;padding:0 .4em;color:#495050">26</span>            <span style=color:#719e07>return</span> value_;
<span style="margin-right:.4em;padding:0 .4em;color:#495050">27</span>        }
<span style="margin-right:.4em;padding:0 .4em;color:#495050">28</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050">29</span>        <span style=color:#dc322f>int</span> <span style=color:#268bd2>accept</span>(expression_visitor <span style=color:#719e07>&amp;</span>v)
<span style="margin-right:.4em;padding:0 .4em;color:#495050">30</span>        {
<span style="margin-right:.4em;padding:0 .4em;color:#495050">31</span>            <span style=color:#719e07>return</span> v.visit_number(<span style=color:#719e07>*</span><span style=color:#719e07>this</span>);
<span style="margin-right:.4em;padding:0 .4em;color:#495050">32</span>        }
<span style="margin-right:.4em;padding:0 .4em;color:#495050">33</span>    };
<span style="margin-right:.4em;padding:0 .4em;color:#495050">34</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050">35</span>    <span style=color:#719e07>class</span> <span style=color:#268bd2>binary_expression</span> <span style=color:#719e07>:</span> <span style=color:#719e07>public</span> expression_t
<span style="margin-right:.4em;padding:0 .4em;color:#495050">36</span>    {
<span style="margin-right:.4em;padding:0 .4em;color:#495050">37</span>        expression left_;
<span style="margin-right:.4em;padding:0 .4em;color:#495050">38</span>        expression right_;
<span style="margin-right:.4em;padding:0 .4em;color:#495050">39</span>        <span style=color:#dc322f>char</span> oper_;
<span style="margin-right:.4em;padding:0 .4em;color:#495050">40</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050">41</span>        <span style=color:#719e07>public</span><span style=color:#719e07>:</span>
<span style="margin-right:.4em;padding:0 .4em;color:#495050">42</span>        binary_expression(expression l,
<span style="margin-right:.4em;padding:0 .4em;color:#495050">43</span>                          expression r,
<span style="margin-right:.4em;padding:0 .4em;color:#495050">44</span>                          <span style=color:#dc322f>char</span> o) <span style=color:#719e07>:</span>
<span style="margin-right:.4em;padding:0 .4em;color:#495050">45</span>            left_(move(l)),
<span style="margin-right:.4em;padding:0 .4em;color:#495050">46</span>            right_(move(r)),
<span style="margin-right:.4em;padding:0 .4em;color:#495050">47</span>            oper_(o)
<span style="margin-right:.4em;padding:0 .4em;color:#495050">48</span>        {
<span style="margin-right:.4em;padding:0 .4em;color:#495050">49</span>        }
<span style="margin-right:.4em;padding:0 .4em;color:#495050">50</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050">51</span>        expression_t <span style=color:#719e07>*</span><span style=color:#268bd2>left</span>()
<span style="margin-right:.4em;padding:0 .4em;color:#495050">52</span>        {
<span style="margin-right:.4em;padding:0 .4em;color:#495050">53</span>            <span style=color:#719e07>return</span> left_.get();
<span style="margin-right:.4em;padding:0 .4em;color:#495050">54</span>        }
<span style="margin-right:.4em;padding:0 .4em;color:#495050">55</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050">56</span>        expression_t <span style=color:#719e07>*</span><span style=color:#268bd2>right</span>()
<span style="margin-right:.4em;padding:0 .4em;color:#495050">57</span>        {
<span style="margin-right:.4em;padding:0 .4em;color:#495050">58</span>            <span style=color:#719e07>return</span> right_.get();
<span style="margin-right:.4em;padding:0 .4em;color:#495050">59</span>        }
<span style="margin-right:.4em;padding:0 .4em;color:#495050">60</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050">61</span>        <span style=color:#dc322f>char</span> <span style=color:#268bd2>operation</span>() <span style=color:#719e07>const</span>
<span style="margin-right:.4em;padding:0 .4em;color:#495050">62</span>        {
<span style="margin-right:.4em;padding:0 .4em;color:#495050">63</span>            <span style=color:#719e07>return</span> oper_;
<span style="margin-right:.4em;padding:0 .4em;color:#495050">64</span>        }
<span style="margin-right:.4em;padding:0 .4em;color:#495050">65</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050">66</span>        <span style=color:#dc322f>int</span> <span style=color:#268bd2>accept</span>(expression_visitor <span style=color:#719e07>&amp;</span>v)
<span style="margin-right:.4em;padding:0 .4em;color:#495050">67</span>        {
<span style="margin-right:.4em;padding:0 .4em;color:#495050">68</span>            <span style=color:#719e07>return</span> v.visit_binary(<span style=color:#719e07>*</span><span style=color:#719e07>this</span>);
<span style="margin-right:.4em;padding:0 .4em;color:#495050">69</span>        }
<span style="margin-right:.4em;padding:0 .4em;color:#495050">70</span>    };</code></pre></div>
<p>Nothing special here. An abstract class with a pure virtual method called <code>accept()</code> and two classes implementing it. One represents numbers, other represents binary expressions like 3 * 5. The <code>accept()</code> simply calls a method from the visitor passing the <strong>instance</strong> of itself as argument.</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 1</span>    <span style=color:#719e07>class</span> <span style=color:#268bd2>expression_visitor</span>
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 2</span>    {
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 3</span>    <span style=color:#719e07>public</span><span style=color:#719e07>:</span>
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 4</span>        <span style=color:#719e07>virtual</span> <span style=color:#dc322f>int</span>  visit_number(type_number <span style=color:#719e07>&amp;</span>v) <span style=color:#719e07>=</span> <span style=color:#2aa198>0</span>;
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 5</span>        <span style=color:#719e07>virtual</span> <span style=color:#dc322f>int</span> <span style=color:#268bd2>visit_binary</span>(binary_expression <span style=color:#719e07>&amp;</span>v) <span style=color:#719e07>=</span> <span style=color:#2aa198>0</span>;
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 6</span>        <span style=color:#719e07>virtual</span> <span style=color:#719e07>~</span>expression_visitor();
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 7</span>    };
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 8</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 9</span>    <span style=color:#719e07>class</span> <span style=color:#268bd2>interpreter</span> <span style=color:#719e07>:</span> <span style=color:#719e07>public</span> expression_visitor
<span style="margin-right:.4em;padding:0 .4em;color:#495050">10</span>    {
<span style="margin-right:.4em;padding:0 .4em;color:#495050">11</span>        <span style=color:#dc322f>int</span> <span style=color:#268bd2>visit_number</span>(type_number <span style=color:#719e07>&amp;</span>n)
<span style="margin-right:.4em;padding:0 .4em;color:#495050">12</span>        {
<span style="margin-right:.4em;padding:0 .4em;color:#495050">13</span>            <span style=color:#719e07>return</span> n.get();
<span style="margin-right:.4em;padding:0 .4em;color:#495050">14</span>        }
<span style="margin-right:.4em;padding:0 .4em;color:#495050">15</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050">16</span>        <span style=color:#dc322f>int</span> <span style=color:#268bd2>visit_binary</span>(binary_expression <span style=color:#719e07>&amp;</span>b)
<span style="margin-right:.4em;padding:0 .4em;color:#495050">17</span>        {
<span style="margin-right:.4em;padding:0 .4em;color:#495050">18</span>            <span style=color:#dc322f>int</span> left <span style=color:#719e07>=</span> evaluate(b.left());
<span style="margin-right:.4em;padding:0 .4em;color:#495050">19</span>            <span style=color:#dc322f>int</span> right <span style=color:#719e07>=</span> evaluate(b.right());
<span style="margin-right:.4em;padding:0 .4em;color:#495050">20</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050">21</span>            <span style=color:#719e07>switch</span> (b.operation()) {
<span style="margin-right:.4em;padding:0 .4em;color:#495050">22</span>                <span style=color:#719e07>case</span> <span style=color:#2aa198>&#39;+&#39;</span><span style=color:#719e07>:</span>
<span style="margin-right:.4em;padding:0 .4em;color:#495050">23</span>                    <span style=color:#719e07>return</span> left <span style=color:#719e07>+</span> right;
<span style="margin-right:.4em;padding:0 .4em;color:#495050">24</span>                    <span style=color:#719e07>break</span>;
<span style="margin-right:.4em;padding:0 .4em;color:#495050">25</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050">26</span>                <span style=color:#719e07>case</span> <span style=color:#2aa198>&#39;-&#39;</span><span style=color:#719e07>:</span>
<span style="margin-right:.4em;padding:0 .4em;color:#495050">27</span>                    <span style=color:#719e07>return</span> left <span style=color:#719e07>-</span> right;
<span style="margin-right:.4em;padding:0 .4em;color:#495050">28</span>                    <span style=color:#719e07>break</span>;
<span style="margin-right:.4em;padding:0 .4em;color:#495050">29</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050">30</span>                <span style=color:#719e07>case</span> <span style=color:#2aa198>&#39;*&#39;</span><span style=color:#719e07>:</span>
<span style="margin-right:.4em;padding:0 .4em;color:#495050">31</span>                    <span style=color:#719e07>return</span> left <span style=color:#719e07>*</span> right;
<span style="margin-right:.4em;padding:0 .4em;color:#495050">32</span>                    <span style=color:#719e07>break</span>;
<span style="margin-right:.4em;padding:0 .4em;color:#495050">33</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050">34</span>                <span style=color:#719e07>case</span> <span style=color:#2aa198>&#39;/&#39;</span><span style=color:#719e07>:</span>
<span style="margin-right:.4em;padding:0 .4em;color:#495050">35</span>                    <span style=color:#719e07>return</span> left <span style=color:#719e07>/</span> right;
<span style="margin-right:.4em;padding:0 .4em;color:#495050">36</span>                    <span style=color:#719e07>break</span>;
<span style="margin-right:.4em;padding:0 .4em;color:#495050">37</span>            }
<span style="margin-right:.4em;padding:0 .4em;color:#495050">38</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050">39</span>            <span style=color:#719e07>throw</span> exception();
<span style="margin-right:.4em;padding:0 .4em;color:#495050">40</span>        }
<span style="margin-right:.4em;padding:0 .4em;color:#495050">41</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050">42</span>        <span style=color:#dc322f>int</span> <span style=color:#268bd2>evaluate</span>(expression_t <span style=color:#719e07>*</span>e)
<span style="margin-right:.4em;padding:0 .4em;color:#495050">43</span>        {
<span style="margin-right:.4em;padding:0 .4em;color:#495050">44</span>            <span style=color:#719e07>return</span> e<span style=color:#719e07>-&gt;</span>accept(<span style=color:#719e07>*</span><span style=color:#719e07>this</span>);
<span style="margin-right:.4em;padding:0 .4em;color:#495050">45</span>        }
<span style="margin-right:.4em;padding:0 .4em;color:#495050">46</span>    };</code></pre></div>
<p>Now, the visitor. The interpreter implements the visitor, giving meaning to each object that it needs to visit. Note that <code>visit_number()</code> returns the value stored in <code>type_number</code> and <code>visit_binary()</code> evaluates both <code>left()</code> and <code>right()</code> expressions - that can hold either <code>type_number</code> or other <code>binary_expression</code>. In other words, <code>visit_binary()</code> be called recursively until it finds a <code>type_number</code>. Isn&rsquo;t it beautiful and elegant?</p>
<p><img loading=lazy src=/visitor_diagram.png alt="visitor diagram">
</p>
<h3 id=full-code-listing>Full code listing<a hidden class=anchor aria-hidden=true href=#full-code-listing>#</a></h3>
<p>Here is the full code listing:</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style="margin-right:.4em;padding:0 .4em;color:#495050">  1</span>    <span style=color:#719e07>#include</span> <span style=color:#719e07>&lt;iostream&gt;</span><span style=color:#719e07>
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">  2</span><span style=color:#719e07></span>    <span style=color:#719e07>#include</span> <span style=color:#719e07>&lt;string&gt;</span><span style=color:#719e07>
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">  3</span><span style=color:#719e07></span>    <span style=color:#719e07>#include</span> <span style=color:#719e07>&lt;memory&gt;</span><span style=color:#719e07>
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">  4</span><span style=color:#719e07></span>    <span style=color:#719e07>#include</span> <span style=color:#719e07>&lt;sstream&gt;</span><span style=color:#719e07>
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">  5</span><span style=color:#719e07></span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050">  6</span>    <span style=color:#719e07>using</span> <span style=color:#719e07>namespace</span> std;
<span style="margin-right:.4em;padding:0 .4em;color:#495050">  7</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050">  8</span>    <span style=color:#719e07>class</span> <span style=color:#268bd2>type_number</span>;
<span style="margin-right:.4em;padding:0 .4em;color:#495050">  9</span>    <span style=color:#719e07>class</span> <span style=color:#268bd2>type_string</span>;
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 10</span>    <span style=color:#719e07>class</span> <span style=color:#268bd2>binary_expression</span>;
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 11</span>    <span style=color:#719e07>class</span> <span style=color:#268bd2>unary_expression</span>;
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 12</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 13</span>    <span style=color:#719e07>class</span> <span style=color:#268bd2>expression_visitor</span>
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 14</span>    {
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 15</span>    <span style=color:#719e07>public</span><span style=color:#719e07>:</span>
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 16</span>        <span style=color:#719e07>virtual</span> <span style=color:#dc322f>int</span>  visit_number(type_number <span style=color:#719e07>&amp;</span>v) <span style=color:#719e07>=</span> <span style=color:#2aa198>0</span>;
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 17</span>        <span style=color:#719e07>virtual</span> <span style=color:#dc322f>int</span> <span style=color:#268bd2>visit_binary</span>(binary_expression <span style=color:#719e07>&amp;</span>v) <span style=color:#719e07>=</span> <span style=color:#2aa198>0</span>;
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 18</span>        <span style=color:#719e07>virtual</span> <span style=color:#719e07>~</span>expression_visitor() {}
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 19</span>    };
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 20</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 21</span>    <span style=color:#719e07>class</span> <span style=color:#268bd2>expression_t</span>
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 22</span>    {
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 23</span>    <span style=color:#719e07>public</span><span style=color:#719e07>:</span>
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 24</span>        <span style=color:#719e07>virtual</span> <span style=color:#dc322f>int</span> accept(expression_visitor <span style=color:#719e07>&amp;</span>v) <span style=color:#719e07>=</span> <span style=color:#2aa198>0</span>;
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 25</span>        <span style=color:#719e07>virtual</span> <span style=color:#719e07>~</span>expression_t() {}
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 26</span>    };
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 27</span>    <span style=color:#719e07>using</span> expression <span style=color:#719e07>=</span> unique_ptr<span style=color:#719e07>&lt;</span>expression_t<span style=color:#719e07>&gt;</span>;
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 28</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 29</span>    <span style=color:#719e07>class</span> <span style=color:#268bd2>type_number</span> <span style=color:#719e07>:</span> <span style=color:#719e07>public</span> expression_t
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 30</span>    {
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 31</span>        <span style=color:#dc322f>int</span> value_;
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 32</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 33</span>    <span style=color:#719e07>public</span><span style=color:#719e07>:</span>
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 34</span>        type_number(<span style=color:#dc322f>int</span> v) <span style=color:#719e07>:</span>
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 35</span>            value_(v)
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 36</span>        {
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 37</span>        }
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 38</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 39</span>        type_number(string v) <span style=color:#719e07>:</span>
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 40</span>            value_(stoi(v))
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 41</span>        {
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 42</span>        }
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 43</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 44</span>        <span style=color:#dc322f>int</span> <span style=color:#268bd2>get</span>() <span style=color:#719e07>const</span>
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 45</span>        {
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 46</span>            <span style=color:#719e07>return</span> value_;
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 47</span>        }
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 48</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 49</span>        <span style=color:#dc322f>int</span> <span style=color:#268bd2>accept</span>(expression_visitor <span style=color:#719e07>&amp;</span>v)
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 50</span>        {
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 51</span>            <span style=color:#719e07>return</span> v.visit_number(<span style=color:#719e07>*</span><span style=color:#719e07>this</span>);
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 52</span>        }
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 53</span>    };
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 54</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 55</span>    <span style=color:#719e07>class</span> <span style=color:#268bd2>binary_expression</span> <span style=color:#719e07>:</span> <span style=color:#719e07>public</span> expression_t
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 56</span>    {
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 57</span>        expression left_;
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 58</span>        expression right_;
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 59</span>        <span style=color:#dc322f>char</span> oper_;
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 60</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 61</span>        <span style=color:#719e07>public</span><span style=color:#719e07>:</span>
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 62</span>        binary_expression(expression l,
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 63</span>                          expression r,
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 64</span>                          <span style=color:#dc322f>char</span> o) <span style=color:#719e07>:</span>
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 65</span>            left_(move(l)),
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 66</span>            right_(move(r)),
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 67</span>            oper_(o)
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 68</span>        {
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 69</span>        }
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 70</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 71</span>        expression_t <span style=color:#719e07>*</span><span style=color:#268bd2>left</span>()
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 72</span>        {
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 73</span>            <span style=color:#719e07>return</span> left_.get();
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 74</span>        }
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 75</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 76</span>        expression_t <span style=color:#719e07>*</span><span style=color:#268bd2>right</span>()
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 77</span>        {
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 78</span>            <span style=color:#719e07>return</span> right_.get();
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 79</span>        }
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 80</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 81</span>        <span style=color:#dc322f>char</span> <span style=color:#268bd2>operation</span>() <span style=color:#719e07>const</span>
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 82</span>        {
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 83</span>            <span style=color:#719e07>return</span> oper_;
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 84</span>        }
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 85</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 86</span>        <span style=color:#dc322f>int</span> <span style=color:#268bd2>accept</span>(expression_visitor <span style=color:#719e07>&amp;</span>v)
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 87</span>        {
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 88</span>            <span style=color:#719e07>return</span> v.visit_binary(<span style=color:#719e07>*</span><span style=color:#719e07>this</span>);
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 89</span>        }
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 90</span>    };
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 91</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 92</span>    <span style=color:#719e07>class</span> <span style=color:#268bd2>interpreter</span> <span style=color:#719e07>:</span> <span style=color:#719e07>public</span> expression_visitor
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 93</span>    {
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 94</span>        <span style=color:#dc322f>int</span> <span style=color:#268bd2>visit_number</span>(type_number <span style=color:#719e07>&amp;</span>n)
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 95</span>        {
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 96</span>            <span style=color:#719e07>return</span> n.get();
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 97</span>        }
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 98</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050"> 99</span>        <span style=color:#dc322f>int</span> <span style=color:#268bd2>visit_binary</span>(binary_expression <span style=color:#719e07>&amp;</span>b)
<span style="margin-right:.4em;padding:0 .4em;color:#495050">100</span>        {
<span style="margin-right:.4em;padding:0 .4em;color:#495050">101</span>            <span style=color:#dc322f>int</span> left <span style=color:#719e07>=</span> evaluate(b.left());
<span style="margin-right:.4em;padding:0 .4em;color:#495050">102</span>            <span style=color:#dc322f>int</span> right <span style=color:#719e07>=</span> evaluate(b.right());
<span style="margin-right:.4em;padding:0 .4em;color:#495050">103</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050">104</span>            <span style=color:#719e07>switch</span> (b.operation()) {
<span style="margin-right:.4em;padding:0 .4em;color:#495050">105</span>                <span style=color:#719e07>case</span> <span style=color:#2aa198>&#39;+&#39;</span><span style=color:#719e07>:</span>
<span style="margin-right:.4em;padding:0 .4em;color:#495050">106</span>                    <span style=color:#719e07>return</span> left <span style=color:#719e07>+</span> right;
<span style="margin-right:.4em;padding:0 .4em;color:#495050">107</span>                    <span style=color:#719e07>break</span>;
<span style="margin-right:.4em;padding:0 .4em;color:#495050">108</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050">109</span>                <span style=color:#719e07>case</span> <span style=color:#2aa198>&#39;-&#39;</span><span style=color:#719e07>:</span>
<span style="margin-right:.4em;padding:0 .4em;color:#495050">110</span>                    <span style=color:#719e07>return</span> left <span style=color:#719e07>-</span> right;
<span style="margin-right:.4em;padding:0 .4em;color:#495050">111</span>                    <span style=color:#719e07>break</span>;
<span style="margin-right:.4em;padding:0 .4em;color:#495050">112</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050">113</span>                <span style=color:#719e07>case</span> <span style=color:#2aa198>&#39;*&#39;</span><span style=color:#719e07>:</span>
<span style="margin-right:.4em;padding:0 .4em;color:#495050">114</span>                    <span style=color:#719e07>return</span> left <span style=color:#719e07>*</span> right;
<span style="margin-right:.4em;padding:0 .4em;color:#495050">115</span>                    <span style=color:#719e07>break</span>;
<span style="margin-right:.4em;padding:0 .4em;color:#495050">116</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050">117</span>                <span style=color:#719e07>case</span> <span style=color:#2aa198>&#39;/&#39;</span><span style=color:#719e07>:</span>
<span style="margin-right:.4em;padding:0 .4em;color:#495050">118</span>                    <span style=color:#719e07>return</span> left <span style=color:#719e07>/</span> right;
<span style="margin-right:.4em;padding:0 .4em;color:#495050">119</span>                    <span style=color:#719e07>break</span>;
<span style="margin-right:.4em;padding:0 .4em;color:#495050">120</span>            }
<span style="margin-right:.4em;padding:0 .4em;color:#495050">121</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050">122</span>            <span style=color:#719e07>throw</span> exception();
<span style="margin-right:.4em;padding:0 .4em;color:#495050">123</span>        }
<span style="margin-right:.4em;padding:0 .4em;color:#495050">124</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050">125</span>        <span style=color:#dc322f>int</span> <span style=color:#268bd2>evaluate</span>(expression_t <span style=color:#719e07>*</span>e)
<span style="margin-right:.4em;padding:0 .4em;color:#495050">126</span>        {
<span style="margin-right:.4em;padding:0 .4em;color:#495050">127</span>            <span style=color:#719e07>return</span> e<span style=color:#719e07>-&gt;</span>accept(<span style=color:#719e07>*</span><span style=color:#719e07>this</span>);
<span style="margin-right:.4em;padding:0 .4em;color:#495050">128</span>        }
<span style="margin-right:.4em;padding:0 .4em;color:#495050">129</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050">130</span>        <span style=color:#719e07>public</span><span style=color:#719e07>:</span>
<span style="margin-right:.4em;padding:0 .4em;color:#495050">131</span>        <span style=color:#dc322f>void</span> compute(expression x)
<span style="margin-right:.4em;padding:0 .4em;color:#495050">132</span>        {
<span style="margin-right:.4em;padding:0 .4em;color:#495050">133</span>            cout <span style=color:#719e07>&lt;&lt;</span> evaluate(x.get()) <span style=color:#719e07>&lt;&lt;</span> endl;
<span style="margin-right:.4em;padding:0 .4em;color:#495050">134</span>        }
<span style="margin-right:.4em;padding:0 .4em;color:#495050">135</span>    };
<span style="margin-right:.4em;padding:0 .4em;color:#495050">136</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050">137</span>    <span style=color:#719e07>class</span> <span style=color:#268bd2>parser</span>
<span style="margin-right:.4em;padding:0 .4em;color:#495050">138</span>    {
<span style="margin-right:.4em;padding:0 .4em;color:#495050">139</span>        <span style=color:#719e07>private</span><span style=color:#719e07>:</span>
<span style="margin-right:.4em;padding:0 .4em;color:#495050">140</span>        expression parse(string s)
<span style="margin-right:.4em;padding:0 .4em;color:#495050">141</span>        {
<span style="margin-right:.4em;padding:0 .4em;color:#495050">142</span>            stringstream tokens;
<span style="margin-right:.4em;padding:0 .4em;color:#495050">143</span>            tokens <span style=color:#719e07>&lt;&lt;</span> s;
<span style="margin-right:.4em;padding:0 .4em;color:#495050">144</span>            <span style=color:#719e07>return</span> <span style=color:#268bd2>parse_add_sub</span>(tokens);
<span style="margin-right:.4em;padding:0 .4em;color:#495050">145</span>        }
<span style="margin-right:.4em;padding:0 .4em;color:#495050">146</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050">147</span>        expression <span style=color:#268bd2>parse_add_sub</span>(stringstream <span style=color:#719e07>&amp;</span>tk)
<span style="margin-right:.4em;padding:0 .4em;color:#495050">148</span>        {
<span style="margin-right:.4em;padding:0 .4em;color:#495050">149</span>            expression left <span style=color:#719e07>=</span> parse_mult_div(tk);
<span style="margin-right:.4em;padding:0 .4em;color:#495050">150</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050">151</span>            <span style=color:#719e07>while</span> (tk.peek() <span style=color:#719e07>==</span> <span style=color:#2aa198>&#39;+&#39;</span> <span style=color:#719e07>||</span> tk.peek() <span style=color:#719e07>==</span> <span style=color:#2aa198>&#39;-&#39;</span>) {
<span style="margin-right:.4em;padding:0 .4em;color:#495050">152</span>                <span style=color:#dc322f>char</span> operation <span style=color:#719e07>=</span> tk.get();
<span style="margin-right:.4em;padding:0 .4em;color:#495050">153</span>                expression right <span style=color:#719e07>=</span> parse_mult_div(tk);
<span style="margin-right:.4em;padding:0 .4em;color:#495050">154</span>                left <span style=color:#719e07>=</span> make_unique<span style=color:#719e07>&lt;</span>binary_expression<span style=color:#719e07>&gt;</span>(move(left),
<span style="margin-right:.4em;padding:0 .4em;color:#495050">155</span>                                                      move(right),
<span style="margin-right:.4em;padding:0 .4em;color:#495050">156</span>                                                      operation);
<span style="margin-right:.4em;padding:0 .4em;color:#495050">157</span>            }
<span style="margin-right:.4em;padding:0 .4em;color:#495050">158</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050">159</span>            <span style=color:#719e07>return</span> left;
<span style="margin-right:.4em;padding:0 .4em;color:#495050">160</span>        }
<span style="margin-right:.4em;padding:0 .4em;color:#495050">161</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050">162</span>        expression <span style=color:#268bd2>parse_mult_div</span>(stringstream <span style=color:#719e07>&amp;</span>tk)
<span style="margin-right:.4em;padding:0 .4em;color:#495050">163</span>        {
<span style="margin-right:.4em;padding:0 .4em;color:#495050">164</span>            expression left <span style=color:#719e07>=</span> parse_number(tk);
<span style="margin-right:.4em;padding:0 .4em;color:#495050">165</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050">166</span>            <span style=color:#719e07>while</span> (tk.peek() <span style=color:#719e07>==</span> <span style=color:#2aa198>&#39;*&#39;</span> <span style=color:#719e07>||</span> tk.peek() <span style=color:#719e07>==</span> <span style=color:#2aa198>&#39;/&#39;</span>) {
<span style="margin-right:.4em;padding:0 .4em;color:#495050">167</span>                <span style=color:#dc322f>char</span> operation <span style=color:#719e07>=</span> tk.get();
<span style="margin-right:.4em;padding:0 .4em;color:#495050">168</span>                expression right <span style=color:#719e07>=</span> parse_number(tk);
<span style="margin-right:.4em;padding:0 .4em;color:#495050">169</span>                left <span style=color:#719e07>=</span> make_unique<span style=color:#719e07>&lt;</span>binary_expression<span style=color:#719e07>&gt;</span>(move(left),
<span style="margin-right:.4em;padding:0 .4em;color:#495050">170</span>                                                      move(right),
<span style="margin-right:.4em;padding:0 .4em;color:#495050">171</span>                                                      operation);
<span style="margin-right:.4em;padding:0 .4em;color:#495050">172</span>            }
<span style="margin-right:.4em;padding:0 .4em;color:#495050">173</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050">174</span>            <span style=color:#719e07>return</span> left;
<span style="margin-right:.4em;padding:0 .4em;color:#495050">175</span>        }
<span style="margin-right:.4em;padding:0 .4em;color:#495050">176</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050">177</span>        expression <span style=color:#268bd2>parse_number</span>(stringstream <span style=color:#719e07>&amp;</span>tk)
<span style="margin-right:.4em;padding:0 .4em;color:#495050">178</span>        {
<span style="margin-right:.4em;padding:0 .4em;color:#495050">179</span>            string sval;
<span style="margin-right:.4em;padding:0 .4em;color:#495050">180</span>            tk <span style=color:#719e07>&gt;&gt;</span> sval;
<span style="margin-right:.4em;padding:0 .4em;color:#495050">181</span>            <span style=color:#dc322f>int</span> value <span style=color:#719e07>=</span> <span style=color:#2aa198>0</span>;
<span style="margin-right:.4em;padding:0 .4em;color:#495050">182</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050">183</span>            <span style=color:#719e07>try</span> {
<span style="margin-right:.4em;padding:0 .4em;color:#495050">184</span>                value <span style=color:#719e07>=</span> stoi(sval);
<span style="margin-right:.4em;padding:0 .4em;color:#495050">185</span>            }
<span style="margin-right:.4em;padding:0 .4em;color:#495050">186</span>            <span style=color:#719e07>catch</span> (invalid_argument <span style=color:#719e07>&amp;</span>e) {
<span style="margin-right:.4em;padding:0 .4em;color:#495050">187</span>                cerr <span style=color:#719e07>&lt;&lt;</span> <span style=color:#2aa198>&#34;expected a number, found &#34;</span> <span style=color:#719e07>&lt;&lt;</span> sval <span style=color:#719e07>&lt;&lt;</span> endl;
<span style="margin-right:.4em;padding:0 .4em;color:#495050">188</span>                exit(<span style=color:#2aa198>1</span>);
<span style="margin-right:.4em;padding:0 .4em;color:#495050">189</span>            }
<span style="margin-right:.4em;padding:0 .4em;color:#495050">190</span>            <span style=color:#719e07>catch</span> (out_of_range <span style=color:#719e07>&amp;</span>e) {
<span style="margin-right:.4em;padding:0 .4em;color:#495050">191</span>                cerr <span style=color:#719e07>&lt;&lt;</span> <span style=color:#2aa198>&#34;number &#34;</span> <span style=color:#719e07>&lt;&lt;</span> sval <span style=color:#719e07>&lt;&lt;</span> <span style=color:#2aa198>&#34; overflows an integer storage&#34;</span> <span style=color:#719e07>&lt;&lt;</span> endl;
<span style="margin-right:.4em;padding:0 .4em;color:#495050">192</span>                exit(<span style=color:#2aa198>1</span>);
<span style="margin-right:.4em;padding:0 .4em;color:#495050">193</span>            }
<span style="margin-right:.4em;padding:0 .4em;color:#495050">194</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050">195</span>            <span style=color:#719e07>while</span> (tk.peek() <span style=color:#719e07>==</span> <span style=color:#2aa198>&#39; &#39;</span>)
<span style="margin-right:.4em;padding:0 .4em;color:#495050">196</span>                tk.get();
<span style="margin-right:.4em;padding:0 .4em;color:#495050">197</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050">198</span>            <span style=color:#719e07>return</span> make_unique<span style=color:#719e07>&lt;</span>type_number<span style=color:#719e07>&gt;</span>(value);
<span style="margin-right:.4em;padding:0 .4em;color:#495050">199</span>        }
<span style="margin-right:.4em;padding:0 .4em;color:#495050">200</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050">201</span>        <span style=color:#719e07>public</span><span style=color:#719e07>:</span>
<span style="margin-right:.4em;padding:0 .4em;color:#495050">202</span>        expression parse_it(string s)
<span style="margin-right:.4em;padding:0 .4em;color:#495050">203</span>        {
<span style="margin-right:.4em;padding:0 .4em;color:#495050">204</span>            <span style=color:#719e07>return</span> <span style=color:#268bd2>parse</span>(s);
<span style="margin-right:.4em;padding:0 .4em;color:#495050">205</span>        }
<span style="margin-right:.4em;padding:0 .4em;color:#495050">206</span>    };
<span style="margin-right:.4em;padding:0 .4em;color:#495050">207</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050">208</span>    <span style=color:#dc322f>int</span> <span style=color:#268bd2>main</span>()
<span style="margin-right:.4em;padding:0 .4em;color:#495050">209</span>    {
<span style="margin-right:.4em;padding:0 .4em;color:#495050">210</span>        interpreter it;
<span style="margin-right:.4em;padding:0 .4em;color:#495050">211</span>        parser p;
<span style="margin-right:.4em;padding:0 .4em;color:#495050">212</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050">213</span>        <span style=color:#719e07>while</span> (<span style=color:#b58900>true</span>) {
<span style="margin-right:.4em;padding:0 .4em;color:#495050">214</span>            string line;
<span style="margin-right:.4em;padding:0 .4em;color:#495050">215</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050">216</span>            getline(cin, line);
<span style="margin-right:.4em;padding:0 .4em;color:#495050">217</span>            <span style=color:#719e07>if</span> (line <span style=color:#719e07>==</span> <span style=color:#2aa198>&#34;quit&#34;</span>)
<span style="margin-right:.4em;padding:0 .4em;color:#495050">218</span>                <span style=color:#719e07>break</span>;
<span style="margin-right:.4em;padding:0 .4em;color:#495050">219</span>    
<span style="margin-right:.4em;padding:0 .4em;color:#495050">220</span>            it.compute(p.parse_it(line));
<span style="margin-right:.4em;padding:0 .4em;color:#495050">221</span>        }
<span style="margin-right:.4em;padding:0 .4em;color:#495050">222</span>        <span style=color:#719e07>return</span> <span style=color:#2aa198>0</span>;
<span style="margin-right:.4em;padding:0 .4em;color:#495050">223</span>    }</code></pre></div>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console>    g++ -std=c++14 -Wall -Wextra -g visitors.cpp -o visitors
    % ./visitors
    3 * 5 + 8 - 3
    20
    15 * 80 / 2 + 3 * 8
    624
    quit
</code></pre></div>
</div>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=https://ziviani.net/tags/c++/>C++</a></li>
<li><a href=https://ziviani.net/tags/design-patterns/>design patterns</a></li>
<li><a href=https://ziviani.net/tags/oo/>OO</a></li>
</ul>
<nav class=paginav>
<a class=prev href=https://ziviani.net/posts/cppcon-mustsee/>
<span class=title>« Prev Page</span>
<br>
<span>CPPCon 2017</span>
</a>
<a class=next href=https://ziviani.net/posts/functions-in-assembly-ii/>
<span class=title>Next Page »</span>
<br>
<span>Functions in Assembly - Part II</span>
</a>
</nav>
</footer>
</article>
</main>
<footer class=footer>
<span>&copy; 2022 <a href=https://ziviani.net/>ziviani.net</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
</body>
</html>